
<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lichtmikroskop ‚Äî Interaktives Arbeitsblatt (Jg. 9, mit Theorieteil)</title>
<meta name="description" content="Interaktives AB zum Lichtmikroskop f√ºr Jg. 9. Mit Theorieteil und √úbungsaufgaben.">
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --panel-2:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#22c55e; --warn:#f59e0b; --error:#ef4444; --ok:#10b981; --focus:#60a5fa;
    --theory:#8b5cf6; --practice:#0ea5e9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a 20%,#0f172a);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{padding:1rem 1.25rem;border-bottom:1px solid #1f2937;background:#0b1220;position:sticky;top:0;z-index:20;display:flex;gap:1rem;align-items:flex-start;justify-content:space-between}
  header h1{margin:.2rem 0 .3rem;font-size:1.05rem}
  header .right{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .6rem;border-radius:999px;background:#111827;border:1px solid #243145;color:var(--muted);font-size:.85rem}
  .score{font-weight:700;color:#93c5fd}
  main{max-width:1100px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
  .card{background:radial-gradient(1200px 500px at -10% -50%, #1b2a4a 0%, transparent 60%) , var(--panel);border:1px solid #1f2a44;border-radius:18px;padding:1rem;box-shadow:0 8px 30px rgba(0,0,0,.35)}
  .card h2{margin:.2rem 0 .5rem;font-size:1.1rem}
  .small{font-size:.9rem;color:var(--muted)}
  .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  button{cursor:pointer;background:#0ea5e9;border:0;color:white;padding:.55rem .85rem;border-radius:12px;font-weight:600;box-shadow:0 6px 16px rgba(14,165,233,.25)}
  button:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
  .btn-secondary{background:#334155}
  .btn-secondary.active{background:#0ea5e9;}
  .btn-ghost{background:#1f2937}
  .btn-theory{background:var(--theory)}
  .btn-practice{background:var(--practice)}
  
  /* Mode Toggle */
  .mode-toggle{display:flex;gap:.5rem;margin-bottom:1rem;padding:1rem;background:#0b1324;border-radius:14px;justify-content:center}
  .mode-toggle button{padding:.7rem 1.2rem;font-size:1rem}
  .mode-toggle button.active{box-shadow:0 0 20px rgba(139,92,246,.4)}
  
  /* Sections */
  .theory-section{display:none}
  .practice-section{display:none}
  body.theory-mode .theory-section{display:block}
  body.practice-mode .practice-section{display:block}
  
  /* Theory Content Styles */
  .theory-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem;align-items:start}
  @media(max-width:768px){.theory-grid{grid-template-columns:1fr}}
  .theory-image{width:100%;max-width:500px;margin:1rem auto;border-radius:12px;overflow:hidden;border:1px solid #1f2a44}
  .theory-image img{width:100%;height:auto;display:block}
  .part-description{background:#0e1526;border-left:4px solid var(--theory);padding:1rem;margin:.5rem 0;border-radius:8px}
  .part-description h4{margin:0 0 .5rem;color:#c4b5fd;font-size:1.05rem}
  .part-description p{margin:0;line-height:1.6}
  .highlight{color:#fbbf24;font-weight:600}
  .tip-box{background:linear-gradient(135deg,#1e293b,#0f172a);border:1px solid #334155;border-radius:12px;padding:1rem;margin:1rem 0}
  .tip-box h4{color:#60a5fa;margin:0 0 .5rem;display:flex;align-items:center;gap:.5rem}
  .tip-box::before{content:"üí°";font-size:1.2rem}
  
  /* Process Steps */
  .process-steps{display:grid;gap:.75rem;margin:1rem 0}
  .process-step{display:flex;gap:1rem;background:#0e1526;padding:1rem;border-radius:10px;border:1px solid #1d2944}
  .step-number{background:var(--theory);color:white;min-width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
  .step-content{flex:1}
  .step-content h5{margin:0 0 .25rem;color:#c4b5fd}
  .step-content p{margin:0;font-size:.9rem;color:#9ca3af}
  
  /* Comparison Table */
  .comparison-table{width:100%;border-collapse:separate;border-spacing:0;margin:1rem 0;background:#0e1526;border-radius:10px;overflow:hidden}
  .comparison-table th{background:#1e293b;padding:.75rem;text-align:left;font-weight:600;color:#c4b5fd;border-bottom:2px solid #334155}
  .comparison-table td{padding:.75rem;border-bottom:1px solid #1f2937}
  .comparison-table tr:last-child td{border-bottom:none}
  .comparison-table tr:hover{background:#111827}
  
  /* Original Styles (rest remains same) */
  .microscope-wrap{display:grid;grid-template-columns:1fr;justify-items:center;gap:.5rem}
  .microscope{position:relative;max-width:680px;width:100%;border-radius:14px;overflow:hidden;border:1px solid #1f2a44;background:#0b1324}
  .microscope img{display:block;width:100%;height:auto}
  .hotspot{position:absolute;width:28px;height:28px;border-radius:50%;background:rgba(96,165,250,.15);border:2px dashed #60a5fa;display:grid;place-items:center;touch-action:none}
  .hotspot span{width:10px;height:10px;border-radius:50%;background:#60a5fa;opacity:.75}
  .hotspot.correct{border-color:#22c55e;background:rgba(34,197,94,.15)}
  .target-name{position:absolute;transform:translate(-50%,-110%);background:#111827;border:1px solid #243145;padding:.22rem .4rem;border-radius:8px;font-size:.8rem;white-space:nowrap;opacity:.9;pointer-events:none}
  .labels{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
  .label-chip{user-select:none;background:#1f2937;border:1px solid #27344d;color:#e5e7eb;padding:.4rem .6rem;border-radius:999px;font-weight:700}
  .label-chip[data-state="active"]{outline:3px solid var(--focus)}
  .label-chip[data-state="placed"]{opacity:.45}
  .teacher-bar{display:none;margin:.5rem 0 0;gap:.5rem;flex-wrap:wrap;align-items:center}
  .teacher-on .teacher-bar{display:flex}
  .teacher-hint{font-size:.9rem;color:#c7d2fe}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
  .meter{height:12px;background:#182036;border-radius:999px;overflow:hidden;border:1px solid #233054}
  .meter>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#22c55e,#0ea5e9)}
  ol.reorder{list-style:none;margin:0;padding:0;display:grid;gap:.5rem}
  .step{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.5rem;background:#0e1526;border:1px solid #1d2944;border-radius:12px;padding:.5rem}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:.35rem}
  .rule{display:flex;gap:.6rem;align-items:flex-start;background:#0e1526;border:1px solid #1d2944;border-radius:10px;padding:.5rem;margin:.35rem 0}
  .focus-canvas{width:100%;height:320px;background:#0b1324;border:1px solid #1f2a44;border-radius:12px;position:relative;overflow:hidden}
  .focus-canvas canvas{position:absolute;inset:0;width:100%;height:100%}
  .focus-controls {display: grid; gap: .5rem 1rem; grid-template-columns: auto 1fr; align-items: center; margin-top:.5rem;}
  .microscope-game{ position:relative; width:100%; max-width:520px; margin:auto; border:1px solid #1f2a44; border-radius:12px; overflow:hidden; background:#0b1324 }
  .microscope-game img{ display:block; width:100%; height:auto }
  .game-overlay{ position:absolute; inset:0; width:100%; height:100% }
  .hit{ fill:rgba(96,165,250,.0); stroke:#60a5fa; stroke-dasharray:6 6; stroke-width:2; opacity:.0; cursor:pointer; touch-action:none; }
  .hit:focus, .hit:hover{ opacity:.25; outline:none }
  .knob-indicator{ position:absolute; width:110px; height:110px; border:2px dashed #60a5fa;
    border-radius:50%; top:68.7%; left:74.8%; transform:translate(-50%,-50%) rotate(0deg); pointer-events:none; opacity:.6 }
  .knob-indicator.small{ width:60px; height:60px; border-color:#f87171; top:68.7%; left:74.8% }
  .microscope-game .hud{ position:absolute; left:.5rem; bottom:.5rem }
  @media print{.teacher-bar,.toolbar button,.labels,.hotspot,.target-name,header{display:none !important}}
  
  /* Aufgabe 2 Styles */
  .parts-grid {display:grid; gap:.75rem; margin:1rem 0}
  .part-box {background:#1f2937; border:2px solid #27344d; padding:.8rem; border-radius:12px; cursor:pointer; transition:all 0.2s}
  .part-box:hover {border-color:#60a5fa; background:#243145}
  .part-box.waiting {border-color:#60a5fa; background:#182036}
  .part-box.correct {border-color:#22c55e; background:rgba(34,197,94,.1)}
  .part-title {font-weight:700; font-size:1.05rem; margin-bottom:.4rem}
  .part-function {font-size:.9rem; color:#9ca3af; min-height:1.5rem}
  .part-function.filled {color:#e5e7eb}
  .function-chips {display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin-top:1rem}
  .function-chip {background:#0e1526; border:2px solid #1d2944; color:#e5e7eb; padding:.5rem .75rem; 
                  border-radius:999px; cursor:pointer; font-size:.9rem; transition:all 0.2s}
  .function-chip:hover {border-color:#60a5fa; background:#182036}
  .function-chip[data-state="active"] {border-color:#60a5fa; background:#243145; outline:2px solid var(--focus)}
  .function-chip[data-state="placed"] {opacity:.45; cursor:default}
</style>
</head>
<body class="theory-mode">
<header>
  <div>
    <h1>Lichtmikroskop ‚Äî Interaktives Arbeitsblatt (Jg. 9)</h1>
    <div class="small">Mit Theorieteil und interaktiven √úbungen. Punkte: <span class="pill"><span id="score" class="score">0</span></span></div>
  </div>
  <div class="right">
    <button id="toggleTeacher" class="btn-ghost" aria-pressed="false" title="Lehrermodus ein/aus">Lehrermodus</button>
  </div>
</header>

<main>
  <!-- Mode Toggle -->
  <div class="mode-toggle">
    <button id="theoryModeBtn" class="btn-theory active">üìö Lernmodus</button>
    <button id="practiceModeBtn" class="btn-practice">‚úèÔ∏è √úbungsmodus</button>
  </div>

  <!-- THEORY SECTION -->
  <div class="theory-section">
    <section class="card">
      <h2>üî¨ Das Lichtmikroskop ‚Äî Aufbau und Funktion</h2>
      <p>Das Lichtmikroskop ist eines der wichtigsten Werkzeuge in den Naturwissenschaften. Es erm√∂glicht uns, Strukturen zu sehen, die f√ºr das blo√üe Auge unsichtbar sind ‚Äî von Zellen √ºber Bakterien bis hin zu winzigen Kristallen.</p>
      
      <div class="tip-box">
        <h4>Grundprinzip der Mikroskopie</h4>
        <p>Ein Mikroskop vergr√∂√üert kleine Objekte durch ein System aus Linsen. Das Licht durchstrahlt das Pr√§parat von unten, wird durch die Objektive geb√ºndelt und durch das Okular nochmals vergr√∂√üert. Die <span class="highlight">Gesamtvergr√∂√üerung</span> ergibt sich aus: Objektiv √ó Okular (z.B. 40√ó √ó 10√ó = 400√ó)</p>
      </div>
    </section>

    <section class="card">
      <h2>üìã Die Bauteile im Detail</h2>
      
      <div class="theory-grid">
        <div>
          <div class="part-description">
            <h4>1. Okular (Augenst√ºck)</h4>
            <p>Die Linse, durch die du hindurchschaust. Standardvergr√∂√üerung meist 10√ó. Moderne Mikroskope haben oft zwei Okulare (Binokular) f√ºr entspannteres Sehen.</p>
          </div>

          <div class="part-description">
            <h4>2. Tubus</h4>
            <p>Das Verbindungsrohr zwischen Okular und Objektiven. Er h√§lt die optischen Bauteile im richtigen Abstand und sch√ºtzt vor Streulicht.</p>
          </div>

          <div class="part-description">
            <h4>3. Revolver (Objektivrevolver)</h4>
            <p>Drehbare Halterung f√ºr mehrere Objektive. Erm√∂glicht schnellen Wechsel zwischen verschiedenen Vergr√∂√üerungen durch einfaches Drehen.</p>
          </div>

          <div class="part-description">
            <h4>4. Objektive</h4>
            <p>Die wichtigsten optischen Bauteile! Typische Vergr√∂√üerungen: 4√ó, 10√ó, 40√ó, 100√ó (√ñl). Je st√§rker die Vergr√∂√üerung, desto n√§her muss das Objektiv ans Pr√§parat.</p>
          </div>

          <div class="part-description">
            <h4>5. Objekttisch</h4>
            <p>Tr√§gt den Objekttr√§ger mit dem Pr√§parat. Hat meist Klammern zum Fixieren und oft einen Kreuztisch f√ºr pr√§zises Verschieben.</p>
          </div>
        </div>

        <div>
          <div class="theory-image">
            <img src="mikroskopaufbau.jpg" alt="Beschriftetes Lichtmikroskop mit allen wichtigen Bauteilen" />
          </div>

          <div class="part-description">
            <h4>6. Grobtrieb</h4>
            <p>Das gro√üe Rad zum schnellen Einstellen des Abstands zwischen Objektiv und Pr√§parat. <span class="highlight">Vorsicht:</span> Bei hohen Vergr√∂√üerungen (40√ó, 100√ó) nie benutzen!</p>
          </div>

          <div class="part-description">
            <h4>7. Feintrieb</h4>
            <p>Das kleine Rad f√ºr pr√§zise Fokussierung. Bei starken Vergr√∂√üerungen NUR diesen verwenden, um Objektiv und Pr√§parat nicht zu besch√§digen.</p>
          </div>

          <div class="part-description">
            <h4>8. Lichtquelle & Kondensor</h4>
            <p>LED oder Halogenlampe beleuchtet das Pr√§parat von unten. Der Kondensor b√ºndelt das Licht optimal. Die Blende reguliert die Lichtmenge.</p>
          </div>

          <div class="part-description">
            <h4>9. Fu√ü & Stativ</h4>
            <p>Stabiler Standfu√ü und S√§ule tragen alle Bauteile. Beim Transport: Eine Hand am Stativ, eine unter dem Fu√ü!</p>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>üéØ Richtig Mikroskopieren ‚Äî Schritt f√ºr Schritt</h2>
      
      <div class="process-steps">
        <div class="process-step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h5>Vorbereitung</h5>
            <p>Mikroskop auf stabilen Tisch stellen, Stromkabel anschlie√üen, Lampe einschalten und auf mittlere Helligkeit einstellen.</p>
          </div>
        </div>

        <div class="process-step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h5>Objekttr√§ger einlegen</h5>
            <p>Pr√§parat mittig auf den Objekttisch legen, mit Klammern fixieren. Das Deckglas zeigt nach oben!</p>
          </div>
        </div>

        <div class="process-step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h5>Kleinste Vergr√∂√üerung w√§hlen</h5>
            <p>IMMER mit dem 4√ó oder 10√ó Objektiv beginnen! Revolver drehen bis das Objektiv einrastet.</p>
          </div>
        </div>

        <div class="process-step">
          <div class="step-number">4</div>
          <div class="step-content">
            <h5>Grob fokussieren</h5>
            <p>Von der Seite beobachten: Objektiv vorsichtig dem Pr√§parat n√§hern. Dann durchs Okular schauen und langsam nach oben drehen bis ein Bild erscheint.</p>
          </div>
        </div>

        <div class="process-step">
          <div class="step-number">5</div>
          <div class="step-content">
            <h5>Fein fokussieren</h5>
            <p>Mit dem Feintrieb das Bild scharf stellen. Blende anpassen f√ºr optimalen Kontrast.</p>
          </div>
        </div>

        <div class="process-step">
          <div class="step-number">6</div>
          <div class="step-content">
            <h5>Vergr√∂√üerung erh√∂hen</h5>
            <p>Interessanten Bereich in die Mitte bringen, n√§chsth√∂heres Objektiv einrasten lassen. Ab 40√ó: NUR noch Feintrieb verwenden!</p>
          </div>
        </div>
      </div>

      <div class="tip-box">
        <h4>Profi-Tipp: Die Sch√§rfeebene</h4>
        <p>Bei hohen Vergr√∂√üerungen ist die Sch√§rfentiefe sehr gering. Du siehst nur eine d√ºnne Ebene scharf. Durch vorsichtiges Drehen am Feintrieb kannst du verschiedene Ebenen des Pr√§parats "durchfokussieren" und so einen 3D-Eindruck gewinnen!</p>
      </div>
    </section>

    <section class="card">
      <h2>‚ö†Ô∏è Sicherheit & Pflege</h2>
      
      <h3>Die goldenen Regeln:</h3>
      <div class="process-steps">
        <div class="process-step">
          <div class="step-number">‚úì</div>
          <div class="step-content">
            <h5>Transport mit beiden H√§nden</h5>
            <p>Eine Hand am Stativ (Arm), eine unter dem Fu√ü. Niemals nur am Tubus tragen!</p>
          </div>
        </div>

        <div class="process-step">
          <div class="step-number">‚úì</div>
          <div class="step-content">
            <h5>Linsen nur mit Linsenpapier reinigen</h5>
            <p>Niemals Taschentuch oder √Ñrmel verwenden ‚Äî das zerkratzt die empfindlichen Linsen!</p>
          </div>
        </div>

        <div class="process-step">
          <div class="step-number">‚úì</div>
          <div class="step-content">
            <h5>Bei hoher Vergr√∂√üerung: Grobtrieb tabu!</h5>
            <p>Ab 40√ó kann der Grobtrieb Objektiv und Pr√§parat zerst√∂ren. Nur Feintrieb!</p>
          </div>
        </div>

        <div class="process-step">
          <div class="step-number">‚úì</div>
          <div class="step-content">
            <h5>Nach dem Mikroskopieren</h5>
            <p>Kleinstes Objektiv einrasten, Objekttisch s√§ubern, Kabel ordentlich aufwickeln, Schutzh√ºlle aufsetzen.</p>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>üìä Vergr√∂√üerungen im Vergleich</h2>
      
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Objektiv</th>
            <th>Gesamtvergr√∂√üerung (10√ó Okular)</th>
            <th>Typische Anwendung</th>
            <th>Arbeitsabstand</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>4√ó</strong></td>
            <td>40√ó</td>
            <td>√úbersicht, gro√üe Strukturen (z.B. Blattquerschnitt)</td>
            <td>~30 mm</td>
          </tr>
          <tr>
            <td><strong>10√ó</strong></td>
            <td>100√ó</td>
            <td>Pflanzenzellen, gr√∂√üere Einzeller</td>
            <td>~10 mm</td>
          </tr>
          <tr>
            <td><strong>40√ó</strong></td>
            <td>400√ó</td>
            <td>Zellkerne, Bakterien, feine Strukturen</td>
            <td>~3 mm</td>
          </tr>
          <tr>
            <td><strong>100√ó (√ñl)</strong></td>
            <td>1000√ó</td>
            <td>Chromosomen, sehr kleine Bakterien</td>
            <td>~0.2 mm</td>
          </tr>
        </tbody>
      </table>

      <div class="tip-box">
        <h4>Was kann ich in welcher Vergr√∂√üerung sehen?</h4>
        <p>‚Ä¢ <strong>40-100√ó:</strong> Pflanzenzellen mit Zellwand, gro√üe Chloroplasten<br>
        ‚Ä¢ <strong>100-400√ó:</strong> Zellkern, Mitochondrien (als Punkte), rote Blutk√∂rperchen<br>
        ‚Ä¢ <strong>400-1000√ó:</strong> Bakterien, Chromosomen w√§hrend der Zellteilung, Gei√üeln</p>
      </div>
    </section>

    <section class="card">
      <h2>üîç Typische Anf√§ngerfehler vermeiden</h2>
      
      <div class="theory-grid">
        <div>
          <div class="part-description" style="border-left-color:#ef4444">
            <h4>‚ùå Luftblasen im Pr√§parat</h4>
            <p>Deckglas schr√§g aufsetzen und langsam ablegen. √úbersch√ºssige Fl√ºssigkeit mit Filterpapier absaugen.</p>
          </div>

          <div class="part-description" style="border-left-color:#ef4444">
            <h4>‚ùå Zu viel/wenig Licht</h4>
            <p>Mit Blende und Kondensor experimentieren. Zu viel Licht ‚Üí √ºberstrahltes Bild. Zu wenig ‚Üí dunkle Details nicht erkennbar.</p>
          </div>

          <div class="part-description" style="border-left-color:#ef4444">
            <h4>‚ùå Unscharfes Bild trotz Fokussierung</h4>
            <p>Objektiv oder Okular verschmutzt? Mit Linsenpapier reinigen. Pr√§parat zu dick? D√ºnnere Schnitte anfertigen.</p>
          </div>
        </div>

        <div>
          <div class="part-description" style="border-left-color:#22c55e">
            <h4>‚úÖ Systematisches Durchmustern</h4>
            <p>Pr√§parat m√§anderf√∂rmig (schlangenlinienf√∂rmig) abfahren, um nichts zu √ºbersehen.</p>
          </div>

          <div class="part-description" style="border-left-color:#22c55e">
            <h4>‚úÖ K√∂hlern f√ºr Profis</h4>
            <p>Fortgeschrittene Technik zur optimalen Ausleuchtung. Kondensor und Blende perfekt aufeinander abstimmen.</p>
          </div>

          <div class="part-description" style="border-left-color:#22c55e">
            <h4>‚úÖ Protokoll f√ºhren</h4>
            <p>Beobachtungen sofort skizzieren und beschriften. Vergr√∂√üerung, F√§rbung und Besonderheiten notieren.</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- PRACTICE SECTION -->
  <div class="practice-section">
    <section class="card" id="a1">
      <h2>1) Teile des Mikroskops ‚Äî Tip-Tap Labeln</h2>
      <p class="small">Sch√ºler: Label unten ausw√§hlen ‚Üí passende Stelle im Bild tippen. Lehrkraft: Lehrermodus aktivieren, Hotspots setzen/ziehen, speichern.</p>

      <div class="microscope-wrap">
        <div class="microscope" id="microscope" aria-label="Abbildung eines Lichtmikroskops ohne Beschriftung">
          <img src="mikroskop.png" alt="Unbeschriftetes Lichtmikroskop (Okular, Tubus, Revolver, Objektive, Objekttisch, Triebe, Lichtquelle, Fu√ü)"/>
        </div>

        <div class="labels" id="labelList" aria-label="Beschriftungen"></div>

        <div class="teacher-bar" id="teacherBar">
          <span class="teacher-hint">Lehrermodus: Label w√§hlen ‚Üí im Bild tippen oder Punkt ziehen. Positionen sind relativ (in %).</span>
          <button id="saveLocal" class="btn-secondary">In Browser speichern</button>
          <button id="exportJson" class="btn-secondary">Hotspots speichern (JSON)</button>
          <button id="importJson" class="btn-secondary">Hotspots laden (JSON)</button>
          <button id="resetAll" class="btn-ghost">Alle zur√ºcksetzen</button>
          <span class="pill" id="teacherMsg" aria-live="polite"></span>
        </div>

        <div class="toolbar">
          <button id="checkA1" class="btn-secondary">Fortschritt pr√ºfen</button>
          <button id="resetA1" class="btn-ghost">Sch√ºler-Ansicht zur√ºcksetzen</button>
          <span class="pill" id="a1msg" aria-live="polite">Noch keine Auswahl.</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2) Funktionen der Mikroskopteile</h2>
      <p class="small">W√§hle eine Funktion unten aus und tippe dann auf das passende Teil in der Liste.</p>
      
      <div class="parts-grid" id="partsGrid">
        <div class="part-box" data-part="Okular">
          <div class="part-title">Okular</div>
          <div class="part-function" data-empty="Tippe hier nach Auswahl einer Funktion"></div>
        </div>
        <div class="part-box" data-part="Objektive">
          <div class="part-title">Objektive</div>
          <div class="part-function" data-empty="Tippe hier nach Auswahl einer Funktion"></div>
        </div>
        <div class="part-box" data-part="Objekttisch">
          <div class="part-title">Objekttisch</div>
          <div class="part-function" data-empty="Tippe hier nach Auswahl einer Funktion"></div>
        </div>
        <div class="part-box" data-part="Grobtrieb">
          <div class="part-title">Grobtrieb</div>
          <div class="part-function" data-empty="Tippe hier nach Auswahl einer Funktion"></div>
        </div>
        <div class="part-box" data-part="Feintrieb">
          <div class="part-title">Feintrieb</div>
          <div class="part-function" data-empty="Tippe hier nach Auswahl einer Funktion"></div>
        </div>
        <div class="part-box" data-part="Lichtquelle">
          <div class="part-title">Lichtquelle</div>
          <div class="part-function" data-empty="Tippe hier nach Auswahl einer Funktion"></div>
        </div>
      </div>
      
      <div class="function-chips" id="functionChips">
        <button class="function-chip" data-for="Okular">Linse zum Durchschauen, vergr√∂√üert zus√§tzlich</button>
        <button class="function-chip" data-for="Objektive">Verschiedene Linsen f√ºr unterschiedliche Vergr√∂√üerungen</button>
        <button class="function-chip" data-for="Objekttisch">Tr√§gt den Objekttr√§ger mit dem Pr√§parat</button>
        <button class="function-chip" data-for="Grobtrieb">Gro√üe Bewegungen zum groben Einstellen</button>
        <button class="function-chip" data-for="Feintrieb">Kleine, pr√§zise Bewegungen f√ºr die Feineinstellung</button>
        <button class="function-chip" data-for="Lichtquelle">Beleuchtet das Pr√§parat von unten</button>
      </div>
      
      <div class="toolbar">
        <button id="checkA2">Zuordnungen pr√ºfen</button>
        <button id="resetA2" class="btn-ghost">Zur√ºcksetzen</button>
        <span class="pill" id="a2msg">W√§hle eine Funktion und tippe auf das passende Teil</span>
      </div>
    </section>

    <section class="card">
      <h2>3) Fokussieren ‚Äî richtige Reihenfolge</h2>
      <ol class="reorder" id="steps">
        <li class="step" data-id="licht"><span class="pill">Schritt</span><span>Lampe einschalten, Helligkeit m√§√üig einstellen.</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="objekttrager"><span class="pill">Schritt</span><span>Objekttr√§ger auf den Objekttisch und fixieren.</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="kleinste"><span class="pill">Schritt</span><span>Kleinstes Objektiv (4√ó) einrasten.</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="grob"><span class="pill">Schritt</span><span>Mit <b>Grobtrieb</b> ann√§hern, dann langsam entfernen bis etwas sichtbar wird.</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="fein"><span class="pill">Schritt</span><span>Mit <b>Feintrieb</b> scharfstellen.</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="wechsel"><span class="pill">Schritt</span><span>Bei Bedarf h√∂heres Objektiv und nur mit <b>Feintrieb</b> nachfokussieren.</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
      </ol>
      <div class="toolbar"><button id="checkA3">Reihenfolge pr√ºfen</button><span class="pill" id="a3msg"></span></div>
    </section>

    <section class="card">
      <h2>4) Sicherheits- & Bedienregeln</h2>
      <label class="rule"><input type="checkbox" data-ok="true"> Zwei H√§nde beim Tragen: eine am Arm, eine unter dem Fu√ü.</label>
      <label class="rule"><input type="checkbox" data-ok="false"> Direkt mit 40√ó/100√ó starten.</label>
      <label class="rule"><input type="checkbox" data-ok="true"> Objekttr√§ger fixieren, bevor fokussiert wird.</label>
      <label class="rule"><input type="checkbox" data-ok="false"> Grobtrieb ist bei 40√ó/100√ó erlaubt.</label>
      <label class="rule"><input type="checkbox" data-ok="true"> Linsenpapier statt Tuch/√Ñrmel.</label>
      <label class="rule"><input type="checkbox" data-ok="true"> Nach dem Arbeiten: kleinstes Objektiv einrasten, Kabel ordentlich.</label>
      <div class="toolbar"><button id="checkA4">Antworten pr√ºfen</button><span class="pill" id="a4msg"></span></div>
    </section>

    <section class="card" id="focus-game">
      <h2>5) Fokus-Spiel ‚Äî ‚ÄûFinde die scharfe Ebene" (Bildgesteuert)</h2>
      <p class="small">Bediene das Mikroskop direkt am Bild: blauer Ring = <b>Grobtrieb</b>, roter Knopf = <b>Feintrieb</b>, Revolver tippen wechselt Objektive, Lampe tippen √§ndert die Helligkeit.</p>

      <div class="grid2">
        <div class="microscope-game" id="microscopeGame" aria-label="Interaktives Mikroskop-Bild zur Steuerung">
          <img src="mikroskop_game.png" onerror="this.onerror=null;this.src='mirkoskop_game.png';" alt="Mikroskop mit Grob- und Feintrieb (rechts), Revolver (√ºber dem Tisch) und Lampe (links unten)."/>
          <svg class="game-overlay" viewBox="0 0 1000 1500" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
            <circle class="hit" data-control="grob" cx="748" cy="1030" r="145"></circle>
            <circle class="hit" data-control="fein" cx="748" cy="1030" r="55"></circle>
            <ellipse class="hit" data-control="revolver" cx="365" cy="585" rx="145" ry="70"></ellipse>
            <ellipse class="hit" data-control="lampe" cx="305" cy="1075" rx="120" ry="70"></ellipse>
          </svg>

          <div class="knob-indicator" id="grobAngle" aria-hidden="true"></div>
          <div class="knob-indicator small" id="feinAngle" aria-hidden="true"></div>
          <div class="pill hud">
            Obj: <b id="hud-obj">4√ó (40√ó)</b> ¬∑ Grob: <b id="hud-g">0%</b> ¬∑ Fein: <b id="hud-f">0%</b> ¬∑ Licht: <b id="hud-l">100%</b>
          </div>
        </div>

        <div>
          <div class="focus-canvas" aria-label="Fokus-Spiel mit Mikroskopfoto">
            <canvas id="lab" aria-label="Mikroskopisches Bild, unscharf bis scharf je nach Einstellung"></canvas>
          </div>
          <div class="toolbar" style="margin-top:.75rem;">
            <button id="checkA5">Pr√ºfen</button>
            <span class="pill" id="a5msg">Noch nicht gepr√ºft.</span>
          </div>

          <div style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">
            <label for="grob">Grobtrieb:</label>
            <input id="grob" type="range" min="0" max="100" value="0"/>
            <label for="fein">Feintrieb:</label>
            <input id="fein" type="range" min="0" max="100" value="0"/>
            <div id="objective-selector">
              <button class="btn-secondary" data-mag="4">4x</button>
              <button class="btn-secondary" data-mag="10">10x</button>
              <button class="btn-secondary" data-mag="40">40x</button>
              <span class="pill">Gesamtvergr√∂√üerung: <b id="total-mag">40x</b></span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="toolbar">
        <button id="save">Fortschritt speichern (JSON)</button>
        <button id="load" class="btn-secondary">Laden</button>
        <button onclick="window.print()" class="btn-ghost">Drucken / PDF</button>
      </div>
      <p class="small">Punkte sind Gamification ‚Äî fachliche Sicherung in der Nachbesprechung.</p>
    </section>
  </div>
</main>

<script>
/* ============================================================
   MODE TOGGLE
   ============================================================ */
const theoryBtn = document.getElementById('theoryModeBtn');
const practiceBtn = document.getElementById('practiceModeBtn');

theoryBtn.addEventListener('click', () => {
  document.body.className = 'theory-mode';
  theoryBtn.classList.add('active');
  practiceBtn.classList.remove('active');
});

practiceBtn.addEventListener('click', () => {
  document.body.className = 'practice-mode';
  practiceBtn.classList.add('active');
  theoryBtn.classList.remove('active');
  window.dispatchEvent(new Event('resize'));   // <‚Äî Canvas neu bemessen
});

/* ============================================================
   LABEL-KONFIG & HOTSPOTS (Prozentkoordinaten aus JSON)
   ============================================================ */
const LABELS = ["Okular","Tubus","Revolver","Objektive","Objekttisch","Grobtrieb","Feintrieb","Lichtquelle","Fu√ü"];

// Hotspots direkt aus der JSON-Datei implementiert
const DEFAULT_HOTSPOTS = [
  {"name": "Okular", "x": 25.07, "y": 22.54},
  {"name": "Tubus", "x": 33.56, "y": 23.67},
  {"name": "Revolver", "x": 42.76, "y": 35.17},
  {"name": "Objektive", "x": 35.03, "y": 39.00},
  {"name": "Objekttisch", "x": 30.56, "y": 44.34},
  {"name": "Grobtrieb", "x": 55.29, "y": 57.34},
  {"name": "Feintrieb", "x": 59.91, "y": 53.17},
  {"name": "Lichtquelle", "x": 38.68, "y": 60.51},
  {"name": "Fu√ü", "x": 29.26, "y": 65.01}
];

function loadHotspotsFromStorage(){
  try{ const raw=localStorage.getItem('mikro_hotspots'); if(raw) return JSON.parse(raw);}catch(e){}
  return DEFAULT_HOTSPOTS;
}

/* =================== SCORE =================== */
let score=0; const scoreEl=document.getElementById('score');
function addScore(n){ score=Math.max(0,score+n); scoreEl.textContent=score; }

/* =================== AUFGABE 1 (mit Lehrermodus) =================== */
(function(){
  const container = document.getElementById('microscope');
  const labelList = document.getElementById('labelList');
  const msg = document.getElementById('a1msg');
  const teacherBar = document.getElementById('teacherBar');
  const teacherMsg = document.getElementById('teacherMsg');
  const toggleTeacher = document.getElementById('toggleTeacher');
  let teacherMode = false;

  let config = loadHotspotsFromStorage();
  let activeLabel = null;         // Sch√ºler
  let teacherActiveLabel = null;  // Lehrer
  const solved = new Set();

  // Chips erzeugen
  LABELS.forEach(name=>{
    const b=document.createElement('button');
    b.className='label-chip'; b.dataset.state='idle'; b.dataset.for=name; b.textContent=name;
    b.addEventListener('click', ()=>{
      if(teacherMode){ teacherActiveLabel=name; highlightTeacherChip(); teacherMsg.textContent=`Lehrer: "${name}" aktiv. Tippe/ziehe im Bild.`; }
      else{ if(solved.has(name)) return; activeLabel=b; updateStudentChips(); msg.textContent=`Ausgew√§hlt: ${name}. Tippe auf die passende Stelle.`; }
    });
    labelList.appendChild(b);
  });

  function updateStudentChips(){
    document.querySelectorAll('.label-chip').forEach(c=>{
      const placed = solved.has(c.dataset.for);
      c.dataset.state = placed ? 'placed' : (c===activeLabel ? 'active' : 'idle');
    });
  }
  function highlightTeacherChip(){
    document.querySelectorAll('.label-chip').forEach(c=>{
      c.dataset.state = (c.dataset.for===teacherActiveLabel)?'active':'idle';
    });
  }

  function renderHotspots(){
    container.querySelectorAll('.hotspot').forEach(n=>n.remove());
    config.forEach(h=>{
      const dot=document.createElement('div');
      dot.className='hotspot'; dot.dataset.name=h.name; dot.style.left=h.x+'%'; dot.style.top=h.y+'%'; dot.tabIndex=0;
      dot.appendChild(document.createElement('span'));
      container.appendChild(dot);

      if(teacherMode){
        const tag=document.createElement('div'); tag.className='target-name'; tag.textContent=h.name; dot.appendChild(tag);
      }

      if(teacherMode){
        enableDrag(dot, h);
        dot.addEventListener('click', e=>{
          if(teacherActiveLabel && h.name===teacherActiveLabel){
            const pos = relativePercentFromEvent(e, container);
            h.x=pos.x; h.y=pos.y; dot.style.left=h.x+'%'; dot.style.top=h.y+'%';
            teacherMsg.textContent = `‚Äû${h.name}" auf (${h.x.toFixed(1)}%, ${h.y.toFixed(1)}%).`;
          }
        });
      }else{
        dot.addEventListener('click', ()=>tryPlace(dot));
        dot.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); tryPlace(dot);} });
      }
    });
  }

  function relativePercentFromEvent(e, ref){
    const r = ref.getBoundingClientRect();
    const x = ((e.clientX - r.left)/r.width)*100;
    const y = ((e.clientY - r.top)/r.height)*100;
    return {x:Math.max(0,Math.min(100,x)), y:Math.max(0,Math.min(100,y))};
  }

  function enableDrag(el, model){
    let dragging=false, offX=0, offY=0;
    const start=(cx,cy)=>{ dragging=true; const r=container.getBoundingClientRect(); offX=((cx-r.left)/r.width)*100 - model.x; offY=((cy-r.top)/r.height)*100 - model.y; document.body.style.userSelect='none'; };
    const move=(cx,cy)=>{ if(!dragging) return; const r=container.getBoundingClientRect(); model.x=Math.max(0,Math.min(100, ((cx-r.left)/r.width)*100 - offX)); model.y=Math.max(0,Math.min(100, ((cy-r.top)/r.height)*100 - offY)); el.style.left=model.x+'%'; el.style.top=model.y+'%'; };
    const end=()=>{ if(dragging){ dragging=false; document.body.style.userSelect=''; teacherMsg.textContent=`‚Äû${model.name}": ${model.x.toFixed(1)}%, ${model.y.toFixed(1)}%`; } };
    el.addEventListener('mousedown', e=>{ if(!teacherMode) return; e.preventDefault(); start(e.clientX,e.clientY); });
    window.addEventListener('mousemove', e=>move(e.clientX,e.clientY));
    window.addEventListener('mouseup', end);
    el.addEventListener('touchstart', e=>{ if(!teacherMode) return; const t=e.touches[0]; start(t.clientX,t.clientY); }, {passive:true});
    window.addEventListener('touchmove', e=>{ const t=e.touches?.[0]; if(t) move(t.clientX,t.clientY); }, {passive:true});
    window.addEventListener('touchend', end);
  }

  function placeLabel(h, name){
    const tag=document.createElement('div'); tag.className='target-name'; tag.textContent=name; tag.setAttribute('aria-hidden','true'); h.appendChild(tag);
  }
  function tryPlace(h){
    if(!activeLabel){ msg.textContent='W√§hle erst eine Beschriftung aus.'; return; }
    const expect=h.dataset.name, want=activeLabel.dataset.for;
    if(expect===want){
      if(!solved.has(want)){
        h.classList.add('correct'); placeLabel(h,want); solved.add(want);
        activeLabel.dataset.state='placed'; activeLabel=null; addScore(1);
        msg.innerHTML = `<span class="ok">Richtig!</span> ${want} platziert.`;
        const next=[...labelList.children].find(c=>c.dataset.state==='idle'); if(next){ next.click(); }
      }
    } else { msg.innerHTML = `<span class="err">Falsch:</span> Das ist nicht ‚Äû${want}".`; addScore(-1); }
  }

  function renderAll(){ renderHotspots(); renderChipsStates(); }
  function renderChipsStates(){ if(teacherMode) highlightTeacherChip(); else updateStudentChips(); }

  // Passwortschutz beim Aktivieren
  toggleTeacher.addEventListener('click', ()=>{
    if (!teacherMode) {
      const pw = prompt("Bitte Passwort f√ºr den Lehrermodus eingeben:");
      if (pw !== "Lehrermodus") {
        alert("Falsches Passwort. Zugriff verweigert.");
        return;
      }
    }

    teacherMode = !teacherMode;
    document.body.classList.toggle('teacher-on', teacherMode);
    toggleTeacher.setAttribute('aria-pressed', String(teacherMode));
    toggleTeacher.textContent = teacherMode ? 'Lehrermodus (AN)' : 'Lehrermodus';
    teacherBar.style.display = teacherMode ? 'flex' : 'none';
    teacherActiveLabel = LABELS[0];
    renderAll();
    teacherMsg.textContent = teacherMode ? 'Lehrer: Label w√§hlen und setzen/ziehen. Danach speichern.' : '';
    if (!teacherMode) resetStudentView();
  });

  document.getElementById('saveLocal').addEventListener('click', ()=>{
    localStorage.setItem('mikro_hotspots', JSON.stringify(config));
    teacherMsg.textContent='Gespeichert (Browser). Wird beim n√§chsten Laden automatisch genutzt.';
  });
  document.getElementById('exportJson').addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(config,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mikro_hotspots.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    teacherMsg.textContent='JSON exportiert.';
  });
  document.getElementById('importJson').addEventListener('click', ()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; const txt=await f.text();
      try{ const data=JSON.parse(txt); const names=new Set(data.map(d=>d.name));
        const ok = LABELS.every(n=>names.has(n)); if(!ok) throw new Error('Labels unvollst√§ndig.');
        config=data; renderAll(); teacherMsg.textContent='Hotspots geladen.';
      }catch(e){ alert('Fehler beim Laden: '+e.message); }
    };
    inp.click();
  });
  document.getElementById('resetAll').addEventListener('click', ()=>{
    if(confirm('Alle Hotspots auf Standard zur√ºcksetzen?')){
      config=JSON.parse(JSON.stringify(DEFAULT_HOTSPOTS));
      renderAll(); teacherMsg.textContent='Zur√ºckgesetzt.';
    }
  });

  document.getElementById('checkA1').addEventListener('click', ()=>{
    const rest = LABELS.length - solved.size;
    msg.innerHTML = rest===0 ? '<strong class="ok">Alles korrekt platziert.</strong>' : `Noch <b>${rest}</b> offen.`;
  });
  function resetStudentView(){
    solved.clear(); activeLabel=null; msg.textContent='Zur√ºckgesetzt.';
    document.querySelectorAll('.label-chip').forEach(c=>c.dataset.state='idle');
    container.querySelectorAll('.hotspot').forEach(h=>{h.classList.remove('correct'); h.querySelector('.target-name')?.remove();});
  }
  document.getElementById('resetA1').addEventListener('click', resetStudentView);

  // initial render
  renderAll();
  if(localStorage.getItem('mikro_hotspots')){
    const note=document.createElement('div'); note.className='small'; note.style.marginTop='.25rem'; note.textContent='Hinweis: Hotspots aus Browser-Speicher geladen.'; document.getElementById('a1').appendChild(note);
  }
})();

/* =================== Aufgabe 2 (Tip & Tap Zuordnung) =================== */
(function(){
  const functionChips = document.querySelectorAll('.function-chip');
  const partBoxes = document.querySelectorAll('.part-box');
  const msg = document.getElementById('a2msg');
  const checkBtn = document.getElementById('checkA2');
  const resetBtn = document.getElementById('resetA2');
  
  let activeFunction = null;
  window.a2Assignments = {}; // Global f√ºr Save/Load

  // Function Chips Click Handler
  functionChips.forEach(chip => {
    chip.addEventListener('click', () => {
      if (chip.dataset.state === 'placed') return;
      
      if (activeFunction) {
        activeFunction.dataset.state = 'idle';
      }
      activeFunction = chip;
      chip.dataset.state = 'active';
      
      partBoxes.forEach(box => {
        if (!window.a2Assignments[box.dataset.part]) {
          box.classList.add('waiting');
        }
      });
      msg.textContent = `Funktion ausgew√§hlt: Tippe jetzt auf das passende Teil oben.`;
    });
  });

  // Part Boxes Click Handler
  partBoxes.forEach(box => {
    box.addEventListener('click', () => {
      if (!activeFunction) {
        msg.textContent = 'W√§hle zuerst eine Funktion unten aus.';
        return;
      }
      
      const partName = box.dataset.part;
      const functionText = activeFunction.textContent;
      const functionFor = activeFunction.dataset.for;
      
      if (window.a2Assignments[partName]) {
        const oldChip = [...functionChips].find(c => c.textContent === window.a2Assignments[partName]);
        if (oldChip) oldChip.dataset.state = 'idle';
      }
      
      window.a2Assignments[partName] = functionText;
      const functionEl = box.querySelector('.part-function');
      functionEl.textContent = functionText;
      functionEl.classList.add('filled');
      
      activeFunction.dataset.state = 'placed';
      box.classList.remove('waiting');
      activeFunction = null;
      
      partBoxes.forEach(b => b.classList.remove('waiting'));
      
      if (functionFor === partName) {
        box.classList.add('correct');
        msg.innerHTML = `<span class="ok">Richtig!</span> ${partName} korrekt zugeordnet.`;
      } else {
        box.classList.remove('correct');
        msg.innerHTML = `<span class="warn">Zugeordnet.</span> Pr√ºfe am Ende alle Zuordnungen.`;
      }
      
      const nextFunction = [...functionChips].find(c => c.dataset.state !== 'placed');
      if (nextFunction) {
        setTimeout(() => nextFunction.click(), 300);
      }
    });
    
    box.addEventListener('touchend', (e) => {
      e.preventDefault();
      box.click();
    });
  });

  // Pr√ºfen
  checkBtn.addEventListener('click', () => {
    let correct = 0;
    const total = partBoxes.length;
    
    partBoxes.forEach(box => {
      const partName = box.dataset.part;
      const assignedFunction = window.a2Assignments[partName];
      
      if (!assignedFunction) {
        box.classList.remove('correct');
        return;
      }
      
      const chip = [...functionChips].find(c => c.textContent === assignedFunction);
      if (chip && chip.dataset.for === partName) {
        box.classList.add('correct');
        correct++;
      } else {
        box.classList.remove('correct');
      }
    });
    
    if (correct === total) {
      msg.innerHTML = '<strong class="ok">Perfekt! Alle Funktionen richtig zugeordnet!</strong>';
      addScore(3);
    } else {
      const missing = total - Object.keys(window.a2Assignments).length;
      if (missing > 0) {
        msg.innerHTML = `<span class="warn">${correct}/${total} richtig. Noch ${missing} Zuordnung(en) fehlen.</span>`;
      } else {
        msg.innerHTML = `<span class="warn">${correct}/${total} richtig. √úberpr√ºfe die falschen Zuordnungen.</span>`;
      }
      if (correct > 0) addScore(1);
    }
  });

  // Zur√ºcksetzen
  resetBtn.addEventListener('click', () => {
    functionChips.forEach(chip => chip.dataset.state = 'idle');
    partBoxes.forEach(box => {
      box.classList.remove('correct', 'waiting');
      const funcEl = box.querySelector('.part-function');
      funcEl.textContent = funcEl.dataset.empty || 'Tippe hier nach Auswahl einer Funktion';
      funcEl.classList.remove('filled');
    });
    
    window.a2Assignments = {};
    activeFunction = null;
    msg.textContent = 'W√§hle eine Funktion und tippe auf das passende Teil';
  });
  
  document.querySelectorAll('.part-function').forEach(el => {
    if (!el.dataset.empty) {
      el.dataset.empty = 'Tippe hier nach Auswahl einer Funktion';
      el.textContent = el.dataset.empty;
    }
  });
})();

/* =================== Aufgabe 3 =================== */
(function(){
  const list=document.getElementById('steps'), msg=document.getElementById('a3msg');
  const orderOK=['licht','objekttrager','kleinste','grob','fein','wechsel'];
  function move(li,dir){
    if(dir==='up'&&li.previousElementSibling){ list.insertBefore(li,li.previousElementSibling);}
    else if(dir==='down'&&li.nextElementSibling){ list.insertBefore(li.nextElementSibling,li);}
  }
  list.querySelectorAll('.step').forEach(li=>{
    li.querySelector('.up').addEventListener('click',()=>move(li,'up'));
    li.querySelector('.down').addEventListener('click',()=>move(li,'down'));
  });
  document.getElementById('checkA3').addEventListener('click', ()=>{
    const now=[...list.children].map(li=>li.dataset.id);
    const ok=now.every((id,i)=>id===orderOK[i]);
    if(ok){ msg.innerHTML='<strong class="ok">Perfekt ‚Äî richtige Reihenfolge!</strong>'; addScore(3); }
    else { let hint=0; for(let i=0;i<now.length;i++){ if(now[i]===orderOK[i]) hint++; }
      msg.innerHTML=`<span class="warn">Noch nicht korrekt.</span> ${hint}/6 korrekt.`; addScore(-1); }
  });
})();

/* =================== Aufgabe 4 =================== */
(function(){
  const msg=document.getElementById('a4msg');
  document.getElementById('checkA4').addEventListener('click', ()=>{
    const boxes=[...document.querySelectorAll('input[type="checkbox"][data-ok]')];
    let ok=0; boxes.forEach(b=>{ const should=b.dataset.ok==='true'; if(b.checked===should) ok++; });
    if(ok===boxes.length){ msg.innerHTML='<strong class="ok">Alles richtig!</strong>'; addScore(3); }
    else { msg.innerHTML=`<span class="warn">Teilweise korrekt:</span> ${ok}/${boxes.length}.`; addScore(-1); }
  });
})();

/* =================== Aufgabe 5 (Bildgesteuerte Steuerung + Canvas) =================== */
(function(){
  // Canvas und Bild
  const canvas = document.getElementById('lab');
  const ctx = canvas.getContext('2d');
  const msg = document.getElementById('a5msg');

  // HUD
  const hudObj = document.getElementById('hud-obj');
  const hudG = document.getElementById('hud-g');
  const hudF = document.getElementById('hud-f');
  const hudL = document.getElementById('hud-l');
  const grobAngle = document.getElementById('grobAngle');
  const feinAngle = document.getElementById('feinAngle');

  // Fallback-Controls (hidden, aber f√ºr Save/Load weiter genutzt)
  const grobSlider = document.getElementById('grob');
  const feinSlider = document.getElementById('fein');
  const totalMagEl = document.getElementById('total-mag');
  const objectiveButtons = document.querySelectorAll('#objective-selector button');

  // Lade das Pr√§parat-Bild
  const img = new Image();
  let loaded = false;
  let useFallback = false;

  // Zustand
  const okularVergroesserung = 10;
  window.a5_state = {
    aktuellesObjektiv: 4,  // 4, 10, 40
    grob: 0,               // 0..100
    fein: 50,              // 0..100 (Mitte = 50)
    licht: 1.0             // 0.7 .. 1.3
  };

  // Fallback-Funktion f√ºr fehlendes Bild
  function drawFallbackImage(){
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    
    // Fokus-Simulation
    const gesamtFokus = calculateFocus();
    const zielEbene = 0.55;
    const abstand = Math.abs(gesamtFokus - zielEbene);
    const blur = Math.min(20, abstand * (100 + window.a5_state.aktuellesObjektiv * 10));
    
    ctx.save();
    
    // Zoom mit Objektiv
    const zoomFaktor = window.a5_state.aktuellesObjektiv / 4;
    ctx.translate(w/2, h/2);
    ctx.scale(zoomFaktor, zoomFaktor);
    ctx.translate(-w/2, -h/2);
    
    // Blur-Effekt simulieren
    ctx.filter = `blur(${blur}px) brightness(${window.a5_state.licht})`;
    
    // Zeichne simulierte Zellen
    ctx.fillStyle = '#e8d4f0';
    ctx.strokeStyle = '#8b5cf6';
    ctx.lineWidth = 2;
    
    // Mehrere Zellen zeichnen
    for(let i = 0; i < 12; i++){
      const x = (i % 4) * 80 + 60;
      const y = Math.floor(i / 4) * 80 + 60;
      const r = 30;
      
      ctx.beginPath();
      ctx.arc(x, y, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
      
      // Zellkern
      ctx.fillStyle = '#7c3aed';
      ctx.beginPath();
      ctx.arc(x, y, r/3, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = '#e8d4f0';
    }
    
    ctx.restore();
    ctx.filter = "none";
    
    // Info-Text nur bei starker Unsch√§rfe
    if(blur > 10){
      ctx.fillStyle = 'rgba(96,165,250,0.5)';
      ctx.font = '12px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('Fokussiere mit Grob- und Feintrieb', w/2, h-10);
    }
  }

  // Bild laden
  img.src = "Zelle.png";
  
  img.onload = ()=>{ 
    loaded = true;
    useFallback = false;
    console.log("Zelle.png erfolgreich geladen");
    resize(); 
    draw(); 
  };
  
  img.onerror = ()=>{ 
    console.warn("Zelle.png nicht gefunden - verwende Fallback-Darstellung");
    loaded = true;
    useFallback = true;
    msg.innerHTML = '<span class="small">Hinweis: Verwende simulierte Zellen. F√ºr realistische Darstellung bitte "Zelle.png" hinzuf√ºgen.</span>';
    resize();
    draw();
  };

  function resize(){
    const r = canvas.parentElement.getBoundingClientRect();
    canvas.width = Math.max(320, Math.round(r.width));
    canvas.height = Math.round(r.height);
    if(loaded) draw();
  }
  window.addEventListener('resize', resize, {passive:true});

  // Fokusberechnung
  function calculateFocus() {
    const grobWert = window.a5_state.grob / 100;
    const feinWert = ((window.a5_state.fein - 50) / 1000);
    return grobWert + feinWert;
  }

  function draw(){
    if(!loaded) return;
    
    if(useFallback){
      drawFallbackImage();
      return;
    }
    
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    // Fokus -> Blur
    const gesamtFokus = calculateFocus();
    const zielEbene = 0.55;
    const abstand = Math.abs(gesamtFokus - zielEbene);
    const blur = Math.min(20, abstand * (100 + window.a5_state.aktuellesObjektiv * 10));

    // Beleuchtung
    const brightness = window.a5_state.licht;
    const contrast = 1 + (brightness-1)/2;
    ctx.save();
    
    // Zoom mit Objektiv
    const zoomFaktor = window.a5_state.aktuellesObjektiv / 4;
    ctx.translate(w/2, h/2);
    ctx.scale(zoomFaktor, zoomFaktor);
    ctx.translate(-w/2, -h/2);

    ctx.filter = `blur(${blur}px) brightness(${brightness}) contrast(${contrast})`;
    ctx.drawImage(img, 0, 0, w, h);
    ctx.restore();
    ctx.filter = "none";
  }

  // ---------- Interaktives Bild-Overlay ----------
  const overlay = document.querySelector('.microscope-game .game-overlay');
  let drag = null; // {type:'grob'|'fein', cx, cy}

  function toLocalXY(evt){
    const svg = overlay;
    const rect = svg.getBoundingClientRect();
    const x = (evt.touches ? evt.touches[0].clientX : evt.clientX) - rect.left;
    const y = (evt.touches ? evt.touches[0].clientY : evt.clientY) - rect.top;
    // In viewBox-Koordinaten (0..1000, 0..1500) umrechnen
    const vx = x * (svg.viewBox.baseVal.width / rect.width);
    const vy = y * (svg.viewBox.baseVal.height / rect.height);
    return {x:vx, y:vy};
  }

  function angleToPercent(angleDeg){
    // -150¬∞ .. +150¬∞ -> 0..100%
    const clamped = Math.max(-150, Math.min(150, angleDeg));
    return Math.round(((clamped + 150) / 300) * 100);
  }

  function updateHUD(){
    hudObj.textContent = `${window.a5_state.aktuellesObjektiv}√ó (${window.a5_state.aktuellesObjektiv*okularVergroesserung}√ó)`;
    hudG.textContent = `${window.a5_state.grob}%`;
    hudF.textContent = `${window.a5_state.fein}%`;
    hudL.textContent = `${Math.round(window.a5_state.licht*100)}%`;
    totalMagEl.textContent = `${window.a5_state.aktuellesObjektiv*okularVergroesserung}x`;
  }

  function setGrobFromAngle(cx, cy, px, py){
    const angle = Math.atan2(py - cy, px - cx) * 180/Math.PI; // -180..180
    const val = angleToPercent(angle);
    window.a5_state.grob = val;
    grobSlider.value = val;
    grobAngle.style.transform = `translate(-50%,-50%) rotate(${(val/100)*300-150}deg)`;
    updateHUD(); draw();
  }

  function setFeinFromAngle(cx, cy, px, py){
    const angle = Math.atan2(py - cy, px - cx) * 180/Math.PI;
    const val = angleToPercent(angle);
    window.a5_state.fein = val;
    feinSlider.value = val;
    feinAngle.style.transform = `translate(-50%,-50%) rotate(${(val/100)*300-150}deg)`;
    updateHUD(); draw();
  }

  overlay.addEventListener('pointerdown', (e)=>{
    const target = e.target.closest('.hit');
    if(!target) return;
    const type = target.dataset.control;

    if(type === 'revolver'){
      // Objektiv umschalten
      const seq = [4,10,40];
      const idx = seq.indexOf(window.a5_state.aktuellesObjektiv);
      window.a5_state.aktuellesObjektiv = seq[(idx+1)%seq.length];
      // Buttons (Fallback) syncen
      objectiveButtons.forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.mag,10)===window.a5_state.aktuellesObjektiv));
      updateHUD(); draw();
      return;
    }
    if(type === 'lampe'){
      // Lichtstufe toggeln 70% -> 100% -> 130%
      const steps = [0.7,1.0,1.3];
      const i = steps.indexOf(window.a5_state.licht);
      window.a5_state.licht = steps[(i+1)%steps.length];
      updateHUD(); draw();
      return;
    }

    // Drag f√ºr Grob/Fein starten
    const bbox = target.getBBox();
    drag = {type, cx:bbox.x + bbox.width/2, cy:bbox.y + bbox.height/2};
    const p = toLocalXY(e);
    if(type==='grob') setGrobFromAngle(drag.cx, drag.cy, p.x, p.y);
    if(type==='fein') setFeinFromAngle(drag.cx, drag.cy, p.x, p.y);
    overlay.setPointerCapture(e.pointerId);
  });

  overlay.addEventListener('pointermove', (e)=>{
    if(!drag) return;
    const p = toLocalXY(e);
    if(drag.type==='grob') setGrobFromAngle(drag.cx, drag.cy, p.x, p.y);
    if(drag.type==='fein') setFeinFromAngle(drag.cx, drag.cy, p.x, p.y);
  });

  overlay.addEventListener('pointerup', ()=>{ drag=null; });
  overlay.addEventListener('pointercancel', ()=>{ drag=null; });

  // Fallback-Events (Tastatur/Screenreader)
  grobSlider.addEventListener('input', ()=>{
    if (window.a5_state.aktuellesObjektiv >= 40) alert("VORSICHT! Grobtrieb bei starker Vergr√∂√üerung nicht verwenden!");
    window.a5_state.grob = +grobSlider.value;
    updateHUD(); draw();
  });
  feinSlider.addEventListener('input', ()=>{
    window.a5_state.fein = +feinSlider.value;
    updateHUD(); draw();
  });
  objectiveButtons.forEach(button => {
    button.addEventListener('click', () => {
      objectiveButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      window.a5_state.aktuellesObjektiv = parseInt(button.dataset.mag, 10);
      updateHUD(); draw();
    });
  });

  document.getElementById('checkA5').addEventListener('click', ()=>{
    const gesamtFokus = calculateFocus();
    const zielEbene = 0.55;
    const toleranz = 0.1 / window.a5_state.aktuellesObjektiv;
    if (Math.abs(gesamtFokus - zielEbene) < toleranz) {
      msg.innerHTML = '<strong class="ok">Scharf! Du hast die richtige Ebene gefunden.</strong>';
      addScore(3);
    } else {
      let hint = gesamtFokus < zielEbene 
        ? 'Du musst noch etwas h√∂her fokussieren (Grob/Fein nach rechts).' 
        : 'Du bist zu hoch (Grob/Fein nach links).';
      msg.innerHTML = `<span class="warn">Noch unscharf. ${hint}</span>`;
      addScore(-1);
    }
  });

  // API f√ºr Save/Load
  window.a5_applyLoadedState = function(s){
    if(!s) return;
    if(typeof s.objektiv==='number') window.a5_state.aktuellesObjektiv = s.objektiv;
    if(typeof s.grob==='number') window.a5_state.grob = s.grob;
    if(typeof s.fein==='number') window.a5_state.fein = s.fein;
    if(typeof s.licht==='number') window.a5_state.licht = s.licht;

    // Fallback-UI syncen
    grobSlider.value = window.a5_state.grob;
    feinSlider.value = window.a5_state.fein;
    const btn = document.querySelector(`#objective-selector button[data-mag="${window.a5_state.aktuellesObjektiv}"]`);
    if(btn){
      document.querySelectorAll('#objective-selector button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }

    // Indikatoren aktualisieren
    grobAngle.style.transform = `translate(-50%,-50%) rotate(${(window.a5_state.grob/100)*300-150}deg)`;
    feinAngle.style.transform = `translate(-50%,-50%) rotate(${(window.a5_state.fein/100)*300-150}deg)`;
    updateHUD(); draw();
  };

  // Initialisierung
  function initUI(){
    // Default 4x aktiv
    document.querySelector('#objective-selector button[data-mag="4"]').classList.add('active');
    updateHUD();
    // Indikator-Position
    grobAngle.style.transform = `translate(-50%,-50%) rotate(-150deg)`;
    feinAngle.style.transform = `translate(-50%,-50%) rotate(0deg)`;
    
    // Canvas initialisieren
    resize();
    
    // Wenn nach 1 Sekunde kein Bild geladen wurde, Fallback zeichnen
    setTimeout(() => {
      if(!loaded){
        console.warn("Bild konnte nicht geladen werden, verwende Fallback");
        drawFallbackImage();
      }
    }, 1000);
  }
  initUI();
})();

/* =================== SAVE/LOAD Fortschritt =================== */
(function(){
  function data(){
    const a1=[...document.querySelectorAll('.label-chip')].map(c=>({name:c.dataset.for, state:c.dataset.state||'idle'}));
    
    const a2={};
    document.querySelectorAll('.part-box').forEach(box => {
      const funcText = box.querySelector('.part-function').textContent;
      const emptyText = box.querySelector('.part-function').dataset.empty;
      if(funcText && funcText !== emptyText) {
        a2[box.dataset.part] = funcText;
      }
    });
    
    const a3=[...document.querySelectorAll('#steps .step')].map(li=>li.dataset.id);
    const a4=[...document.querySelectorAll('input[type="checkbox"][data-ok]')].map(x=>x.checked);
    
    // Aufgabe 5 Zustand (jetzt aus a5_state)
    const a5 = {
        grob: window.a5_state?.grob ?? +document.getElementById('grob').value,
        fein: window.a5_state?.fein ?? +document.getElementById('fein').value,
        objektiv: window.a5_state?.aktuellesObjektiv ?? 4,
        licht: window.a5_state?.licht ?? 1.0
    };
    
    return {a1,a2,a3,a4,a5,score};
  }
  
  function downloadJSON(obj, filename){
    const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename||'mikroskop_jg9.json';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  }
  
  function loadJSON(file){ 
    return new Promise((res,rej)=>{
      const fr=new FileReader(); 
      fr.onload=()=>{try{res(JSON.parse(fr.result));}catch(e){rej(e)}}; 
      fr.onerror=rej; 
      fr.readAsText(file);
    }); 
  }
  
  document.getElementById('save').addEventListener('click',()=>downloadJSON(data(),'mikroskop_jg9.json'));
  
  document.getElementById('load').addEventListener('click',async()=>{
    const inp=document.createElement('input'); 
    inp.type='file'; 
    inp.accept='application/json';
    inp.onchange=async()=>{ 
      const f=inp.files[0]; 
      if(!f) return; 
      try{ 
        const d=await loadJSON(f);
        
        d.a1?.forEach(s=>{ 
          const c=[...document.querySelectorAll('.label-chip')].find(x=>x.dataset.for===s.name); 
          if(c) c.dataset.state=s.state; 
        });
        
        if(d.a2 && typeof d.a2 === 'object'){
          document.getElementById('resetA2').click();
          Object.entries(d.a2).forEach(([partName, funcText]) => {
            const box = document.querySelector(`.part-box[data-part="${partName}"]`);
            if(box) {
              const funcEl = box.querySelector('.part-function');
              funcEl.textContent = funcText;
              funcEl.classList.add('filled');
              window.a2Assignments[partName] = funcText;
              const chip = [...document.querySelectorAll('.function-chip')].find(c => c.textContent === funcText);
              if(chip) chip.dataset.state = 'placed';
              if(chip && chip.dataset.for === partName) box.classList.add('correct');
            }
          });
        }
        
        const list=document.getElementById('steps'); 
        const map={}; 
        [...list.children].forEach(li=>map[li.dataset.id]=li); 
        d.a3?.forEach(id=>map[id]&&list.appendChild(map[id]));
        
        const boxes=[...document.querySelectorAll('input[type="checkbox"][data-ok]')]; 
        boxes.forEach((b,i)=>{ 
          if(typeof d.a4?.[i]==='boolean') b.checked=d.a4[i]; 
        });
        
        // Aufgabe 5 laden
        if (d.a5) {
          if (typeof window.a5_applyLoadedState === 'function') {
            window.a5_applyLoadedState({
              grob: d.a5.grob ?? 0,
              fein: d.a5.fein ?? 50,
              objektiv: d.a5.objektiv ?? 4,
              licht: d.a5.licht ?? 1.0
            });
          } else {
            // Fallback auf alte Variante
            document.getElementById('grob').value = d.a5.grob ?? 0;
            document.getElementById('fein').value = d.a5.fein ?? 50;
            const objektiv = d.a5.objektiv ?? 4;
            const btn = document.querySelector(`#objective-selector button[data-mag="${objektiv}"]`);
            if (btn) btn.click();
          }
        }
        
        if(typeof d.score==='number'){ 
          score=d.score; 
          document.getElementById('score').textContent=score; 
        }
        
        alert('Fortschritt geladen.');
      }catch(e){ 
        alert('Konnte Datei nicht laden: '+e.message); 
      }
    };
    inp.click();
  });
})();
</script>
</body>
</html>
