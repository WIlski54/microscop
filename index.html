<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lichtmikroskop ‚Äî Interaktives Arbeitsblatt (Jg. 9, mit Theorieteil)</title>
<meta name="description" content="Interaktives AB zum Lichtmikroskop f√ºr Jg. 9. Mit Theorieteil und √úbungsaufgaben.">
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --panel-2:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#22c55e; --warn:#f59e0b; --error:#ef4444; --ok:#10b981; --focus:#60a5fa;
    --theory:#8b5cf6; --practice:#0ea5e9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{display:flex;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid #1d2944;background:#0b1324;position:sticky;top:0;z-index:10}
  header h1{font-size:1.1rem;margin:.15rem 0 .25rem}
  header .small{color:var(--muted);font-size:.9rem}
  .pill{display:inline-flex;align-items:center;gap:.4rem;background:#0e1526;border:1px solid #1d2944;padding:.25rem .5rem;border-radius:999px}
  .pill b{color:#fff}
  .score{font-weight:700;color:#22c55e}
  .btn,.btn-ghost,.btn-secondary{cursor:pointer;display:inline-flex;align-items:center;gap:.5rem;border-radius:8px;border:1px solid #1d2944;padding:.5rem .75rem;background:#132039;color:#e5e7eb}
  .btn:hover,.btn-ghost:hover,.btn-secondary:hover{border-color:#60a5fa;background:#192a4a}
  .btn-ghost{background:transparent}
  .btn-secondary{background:#0e1526}
  .toolbar{display:flex;flex-wrap:wrap;gap:.5rem}
  .grid{display:grid;gap:1rem}
  .grid-2{grid-template-columns:1.2fr .8fr}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  .grid-4{grid-template-columns:repeat(4,1fr)}
  @media(max-width:980px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
  .card{background:#0b1324;border:1px solid #1f2a44;border-radius:12px;padding:1rem}
  .muted{color:var(--muted)}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:#f87171}
  .section-title{display:flex;align-items:center;justify-content:space-between;margin:.25rem 0 1rem}
  .mode-toggle{display:flex;gap:.5rem;align-items:center;justify-content:center;margin:1rem 0}
  .mode-toggle button{padding:.4rem .8rem;border-radius:999px;border:1px solid #1d2944;background:#0e1526;color:#e5e7eb}
  .mode-toggle button.active{border-color:#60a5fa;background:#182036}
  .theory-mode .theory-section{display:block}
  .theory-mode .practice-section{display:none}
  .practice-mode .theory-section{display:none}
  .practice-mode .practice-section{display:block}

  /* Theory */
  .theory-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
  @media(max-width:900px){.theory-grid{grid-template-columns:1fr}}
  .theory-image{background:#0b1324;border:1px solid #1f2a44;border-radius:12px;overflow:hidden}
  .theory-image img{width:100%;height:auto;display:block}
  .part-description{background:#0e1526;border-left:4px solid var(--theory);padding:1rem;margin:.5rem 0;border-radius:8px}
  .part-description h4{margin:0 0 .5rem;color:#c4b5fd;font-size:1.05rem}
  .part-description p{margin:0;line-height:1.6}
  .highlight{color:#fbbf24;font-weight:600}
  .tip-box{background:linear-gradient(135deg,#1e293b,#0f172a);border:1px solid #334155;border-radius:12px;padding:1rem;margin:1rem 0}
  .tip-box h4{color:#60a5fa;margin:0 0 .5rem;display:flex;align-items:center;gap:.5rem}
  .tip-box::before{content:"üí°";font-size:1.2rem}
  
  /* Process Steps */
  .process-steps{display:grid;gap:.75rem;margin:1rem 0}
  .process-step{display:flex;gap:1rem;background:#0e1526;padding:1rem;border-radius:10px;border:1px solid #1d2944}
  .step-number{background:var(--theory);color:white;min-width:32px;min-height:32px;border-radius:999px;display:flex;align-items:center;justify-content:center;font-weight:700}
  .step-content{flex:1}
  .step-content h5{margin:0 0 .25rem;color:#c4b5fd}
  .step-content p{margin:0;color:#cbd5e1}
  
  /* Practice */
  h2{font-size:1.15rem;margin:.25rem 0 .5rem}
  .labels{display:flex;flex-wrap:wrap;gap:.5rem}
  .label-chip{cursor:pointer;background:#0e1526;border:2px solid #1d2944;color:#e5e7eb;padding:.35rem .6rem;border-radius:999px}
  .label-chip[data-state="active"]{background:#182036;border-color:#60a5fa}
  .label-chip[data-state="placed"]{opacity:.45}
  .teacher-bar{display:flex;gap:.5rem;align-items:center;background:#0b1324;border:1px solid #1f2a44;border-radius:12px;padding:.5rem;margin:.5rem 0}
  .teacher-bar small{color:#cbd5e1}
  .theory-image figcaption{font-size:.85rem;color:#94a3b8;padding:.5rem 1rem}
  .sm-note{font-size:.85rem;color:#9ca3af;margin-top:.5rem}

  .microscope-wrap{display:grid;grid-template-columns:1fr;justify-items:center;gap:.5rem}
  .microscope{position:relative;max-width:680px;width:100%;border-radius:12px;overflow:hidden;border:1px solid #1f2a44;background:#0b1324}
  .microscope img{display:block;width:100%;height:auto}
  .hotspot{position:absolute;width:28px;height:28px;border-radius:50%;background:rgba(96,165,250,.15);border:2px solid #60a5fa;transform:translate(-50%,-50%);cursor:pointer}
  .hotspot.correct{background:rgba(34,197,94,.2);border-color:#22c55e}
  .target-name{position:absolute;background:#0e1526;border:1px solid #1d2944;color:#e5e7eb;padding:.25rem .5rem;border-radius:6px;transform:translate(-50%,-120%);white-space:nowrap;font-size:.9rem}
  .teacher-hint{font-size:.9rem;color:#9ca3af}
  .sm{font-size:.9rem}

  /* Aufgabe 5 ‚Äì Fokusspiel */
  .rule{display:flex;gap:.6rem;align-items:flex-start;background:#0e1526;border:1px solid #1d2944;border-radius:10px;padding:.5rem;margin:.35rem 0}
  .focus-canvas{width:100%;height:320px;background:#0b1324;border:1px solid #1f2a44;border-radius:12px;position:relative;overflow:hidden}
  .focus-canvas canvas{position:absolute;inset:0;width:100%;height:100%}
  .focus-controls {display: grid; gap: .5rem 1rem; grid-template-columns: auto 1fr; align-items: center; margin-top:.5rem;}
  .microscope-game{ position:relative; width:100%; max-width:520px; border:1px solid #1f2a44; border-radius:12px; overflow:hidden; background:#0b1324 }
  .microscope-game img{ display:block; width:100%; height:auto }
  .game-overlay{ position:absolute; inset:0; width:100%; height:100% }
  .hit{ fill:rgba(96,165,250,.0); stroke:#60a5fa; stroke-dasharray:4 4; stroke-width:2; opacity:.0; cursor:pointer; touch-action:none; }
  .hit:focus, .hit:hover{ opacity:.25; outline:none }
  .knob-indicator{ position:absolute; width:110px; height:110px; border:2px dashed #60a5fa;
    border-radius:50%; top:68.7%; left:74.8%; transform:translate(-50%,-50%) rotate(0deg); pointer-events:none; opacity:.6 }
  .knob-indicator.small{ width:60px; height:60px; border-color:#f87171; top:68.7%; left:74.8% }
  .microscope-game .hud{ position:absolute; left:.5rem; bottom:.5rem }
  @media print{.teacher-bar,.toolbar button,.labels,.hotspot,.target-name,header{display:none !important}}
  
  /* Aufgabe 2 Styles */
  .parts-grid {display:grid; gap:.75rem; margin:1rem 0}
  .part-box {background:#1f2937; border:2px solid #27344d; padding:1rem; border-radius:12px; cursor:pointer; transition:all 0.2s}
  .part-box:hover {border-color:#60a5fa; background:#243145}
  .part-box.waiting {border-color:#60a5fa; background:#182036}
  .part-box.correct {border-color:#22c55e; background:rgba(34,197,94,.1)}
  .part-title {font-weight:700; font-size:1.05rem; margin-bottom:.4rem}
  .part-function {font-size:.9rem; color:#9ca3af; min-height:1.5rem}
  .part-function.filled {color:#e5e7eb}
  .function-chips {display:flex; gap:.5rem; flex-wrap:wrap; justify-content:center; margin-top:1rem}
  .function-chip {background:#0e1526; border:2px solid #1d2944; color:#e5e7eb; padding:.5rem .75rem; 
                  border-radius:999px; cursor:pointer; font-size:.9rem; transition:all 0.2s}
  .function-chip:hover {border-color:#60a5fa; background:#182036}
  .function-chip[data-state="active"] {border-color:#60a5fa; background:#182036}
  
  /* A3 Reorder */
  .reorder{list-style:none;padding:0;margin:.5rem 0;display:grid;gap:.35rem}
  .step{display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center;background:#0e1526;border:1px solid #1d2944;border-radius:10px;padding:.5rem}
  .step .pill{justify-self:start}
  .grid3{display:grid;grid-template-columns:repeat(3,auto);gap:.35rem}
  
  /* Vergleichstabelle */
  .comparison-table{width:100%;border-collapse:collapse;background:#0e1526;border:1px solid #1d2944;border-radius:10px;overflow:hidden}
  .comparison-table th,.comparison-table td{border-bottom:1px solid #1d2944;padding:.5rem;text-align:left}
  .comparison-table th{background:#0b1324}
  .comparison-table tr:hover{background:#111827}
</style>
</head>

<body class="theory-mode">
<header>
  <div>
    <h1>Lichtmikroskop ‚Äî Interaktives Arbeitsblatt (Jg. 9)</h1>
    <div class="small">Mit Theorieteil und interaktiven √úbungen. <span class="pill">Punkte: <span id="score" class="score">0</span></span></div>
  </div>
  <div class="right">
    <button id="toggleTeacher" class="btn-ghost" aria-pressed="false" title="Lehrermodus ein/aus">Lehrermodus</button>
  </div>
</header>

<main>
  <!-- Mode Toggle -->
  <div class="mode-toggle">
    <button id="theoryModeBtn" class="active">Theorie</button>
    <button id="practiceModeBtn">√úben</button>
  </div>

  <!-- THEORY SECTION -->
  <div class="theory-section">
    <section class="card">
      <h2>üî¨ Das Lichtmikroskop ‚Äî Aufbau und Funktion</h2>
      <p>Das Lichtmikroskop ist eines der wichtigsten Werkzeuge in der Biologie. ‚Ä¶</p>
      <div class="theory-grid">
        <figure class="theory-image">
          <img src="mikroskop_theory.png" alt="Beschriftetes Lichtmikroskop">
          <figcaption>Wichtige Bauteile eines Lichtmikroskops</figcaption>
        </figure>
        <div>
          <div class="part-description"><h4>Okular &amp; Objektive</h4><p>‚Ä¶</p></div>
          <div class="part-description"><h4>Grob- &amp; Feintrieb</h4><p>‚Ä¶</p></div>
          <div class="part-description"><h4>Beleuchtung</h4><p>‚Ä¶</p></div>
          <div class="tip-box"><h4>Grundprinzip der Mikroskopie</h4><p>‚Ä¶</p></div>
        </div>
      </div>
    </section>
  </div>

  <!-- PRACTICE SECTION -->
  <div class="practice-section">

    <!-- Aufgabe 1 (Hotspots, Lehrermodus bleibt unver√§ndert) -->
    <section id="a1" class="card">
      <div class="section-title"><h2>Aufgabe 1: Teile zuordnen</h2></div>
      <div class="labels" id="labelList"></div>
      <div class="microscope-wrap">
        <div class="microscope" id="microscope">
          <img src="mikroskop.png" alt="Mikroskop mit Hotspots"/>
          <!-- Hotspots werden per JS gesetzt -->
        </div>
        <div class="teacher-bar" id="teacherBar" aria-hidden="true">
          <small id="teacherMsg">Lehrermodus aus.</small>
          <div class="toolbar">
            <button class="btn-secondary" id="savePos">Positionen sichern</button>
            <button class="btn-secondary" id="loadPos">Gespeicherte Positionen laden</button>
            <button class="btn-secondary" id="resetAll">Werkseinstellung</button>
          </div>
        </div>
      </div>
      <div class="toolbar">
        <button id="checkA1" class="btn">√úberpr√ºfen</button>
        <button id="resetA1" class="btn-ghost">Zur√ºcksetzen</button>
      </div>
      <div class="sm-note" id="a1msg"></div>
    </section>

    <!-- Aufgabe 2 (Zuordnung, unver√§ndert) -->
    <section id="a2" class="card">
      <div class="section-title"><h2>Aufgabe 2: Funktion &amp; Bauteil</h2></div>
      <div class="parts-grid">
        <div class="part-box" data-part="okular"><div class="part-title">Okular</div><div class="part-function"></div></div>
        <div class="part-box" data-part="objektiv"><div class="part-title">Objektiv</div><div class="part-function"></div></div>
        <div class="part-box" data-part="tisch"><div class="part-title">Objekttisch</div><div class="part-function"></div></div>
        <div class="part-box" data-part="grob"><div class="part-title">Grobtrieb</div><div class="part-function"></div></div>
        <div class="part-box" data-part="fein"><div class="part-title">Feintrieb</div><div class="part-function"></div></div>
        <div class="part-box" data-part="lampe"><div class="part-title">Lampe/Spiegel</div><div class="part-function"></div></div>
      </div>
      <div class="function-chips">
        <button class="function-chip" data-function="vergroessert">Bild vergr√∂√üern</button>
        <button class="function-chip" data-function="fokussiert-grob">Fokussieren (grobe Ann√§herung)</button>
        <button class="function-chip" data-function="fokussiert-fein">Feine Scharfstellung</button>
        <button class="function-chip" data-function="traegt">Pr√§parat tragen</button>
        <button class="function-chip" data-function="beleuchtet">Beleuchten</button>
        <button class="function-chip" data-function="blick">Beobachtung</button>
      </div>
      <div class="toolbar"><button id="checkA2" class="btn">√úberpr√ºfen</button><button id="resetA2" class="btn-ghost">Zur√ºcksetzen</button></div>
      <div class="sm-note" id="a2msg"></div>
    </section>

    <!-- Aufgabe 3 (Reihenfolge, unver√§ndert) -->
    <section id="a3" class="card">
      <div class="section-title"><h2>Aufgabe 3: Reihenfolge beim Mikroskopieren</h2></div>
      <ol class="reorder" id="steps">
        <li class="step" data-id="licht"><span class="pill">Schritt 1</span><span>Licht einstellen</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="objekttrager"><span class="pill">Schritt 2</span><span>Objekttr√§ger auflegen</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="kleinste"><span class="pill">Schritt 3</span><span>Kleinste Vergr√∂√üerung w√§hlen</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="grob"><span class="pill">Schritt 4</span><span>Mit Grobtrieb scharf stellen</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="fein"><span class="pill">Schritt 5</span><span>Mit Feintrieb nachfokussieren</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
        <li class="step" data-id="wechsel"><span class="pill">Schritt 6</span><span>Bei Bedarf auf h√∂heres Objektiv wechseln</span><span class="grid3"><button class="btn-secondary up">‚ñ≤</button><button class="btn-secondary down">‚ñº</button></span></li>
      </ol>
      <div class="toolbar"><button id="checkA3" class="btn">√úberpr√ºfen</button></div>
      <div class="sm-note" id="a3msg"></div>
    </section>

    <!-- Aufgabe 4 (Checkboxen, unver√§ndert) -->
    <section id="a4" class="card">
      <div class="section-title"><h2>Aufgabe 4: Sicherheit &amp; Umgang</h2></div>
      <ul class="process-steps">
        <li class="process-step"><span class="step-number">A</span><span>Pr√§parat niemals zerdr√ºcken <input type="checkbox" data-ok="true"></span></li>
        <li class="process-step"><span class="step-number">B</span><span>Grobtrieb bei 40√ó verwenden <input type="checkbox" data-ok="false"></span></li>
        <li class="process-step"><span class="step-number">C</span><span>Feintrieb f√ºr scharfes Bild <input type="checkbox" data-ok="true"></span></li>
        <li class="process-step"><span class="step-number">D</span><span>Lampe/Spiegel korrekt ausrichten <input type="checkbox" data-ok="true"></span></li>
        <li class="process-step"><span class="step-number">E</span><span>Objekttr√§ger gut fixieren <input type="checkbox" data-ok="true"></span></li>
      </ul>
      <div class="toolbar"><button id="checkA4" class="btn">√úberpr√ºfen</button></div>
      <div class="sm-note" id="a4msg"></div>
    </section>

    <!-- Aufgabe 5: Fokus-Spiel -->
    <section id="a5" class="card">
      <div class="section-title"><h2>Aufgabe 5: Fokussieren &amp; Beleuchtung (Spiel)</h2></div>
      <div class="rule">
        <div>Regeln:</div>
        <ul class="muted" style="margin:.25rem 0;">
          <li>Mit dem gro√üen/kleinen Trieb drehen ‚Üí Fokus einstellen.</li>
          <li>Revolver antippen ‚Üí Objektiv wechseln (4√ó, 10√ó, 40√ó).</li>
          <li>Lampe antippen ‚Üí Helligkeit durchschalten (70 % / 100 % / 130 %).</li>
        </ul>
      </div>

      <div class="microscope-game" id="microscopeGame" aria-label="Interaktives Mikroskop-Bild zur Steuerung">
        <img src="mikroskop_game.png" onerror="this.onerror=null;this.alt='Mikroskop (Spiel)';" alt="Mikroskop (Spiel), Interaktion √ºber Grob-/Feintrieb (rechts), Revolver (√ºber dem Tisch) und Lampe (links unten)."/>
        <svg class="game-overlay" viewBox="0 0 1000 1500" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
          <circle class="hit" data-control="grob" cx="748" cy="1030" r="145"></circle>
          <circle class="hit" data-control="fein" cx="748" cy="1030" r="55"></circle>
          <ellipse class="hit" data-control="revolver" cx="365" cy="585" rx="145" ry="70"></ellipse>
          <ellipse class="hit" data-control="lampe" cx="305" cy="1075" rx="120" ry="70"></ellipse>
        </svg>

        <div class="knob-indicator" id="grobAngle" aria-hidden="true"></div>
        <div class="knob-indicator small" id="feinAngle" aria-hidden="true"></div>
        <div class="hud">
          <div class="pill">Objektiv: <b id="hud-obj">4√ó (40√ó)</b></div>
          <div class="pill">Grob: <b id="hud-g">0%</b></div>
          <div class="pill">Fein: <b id="hud-f">50%</b></div>
          <div class="pill">Licht: <b id="hud-l">100%</b></div>
        </div>
      </div>

      <div class="focus-canvas" aria-label="Fokus-Spiel mit Mikroskopfoto">
        <canvas id="lab" aria-label="Mikroskopisches Bild, unscharf bis scharf je nach Einstellung"></canvas>
      </div>

      <!-- Fallback-Buttons f√ºr Screenreader/Tastatur (optional, k√∂nnen fehlen) -->
      <div class="toolbar" id="objective-selector">
        <button class="btn-secondary" data-mag="4">4x</button>
        <button class="btn-secondary" data-mag="10">10x</button>
        <button class="btn-secondary" data-mag="40">40x</button>
        <span class="pill">Gesamtvergr√∂√üerung: <b id="total-mag">40x</b></span>
      </div>

      <div class="toolbar">
        <button id="checkA5" class="btn">Bildqualit√§t pr√ºfen</button>
        <button id="resetA5" class="btn-ghost">Zur√ºcksetzen</button>
      </div>
      <div class="sm-note" id="a5msg"></div>
    </section>

    <!-- Vergleichstabelle -->
    <section class="card">
      <h2>Vergleich: Mikroskoptypen</h2>
      <table class="comparison-table">
        <thead><tr><th>Typ</th><th>Vorteile</th><th>Grenzen</th></tr></thead>
        <tbody>
          <tr><td>Lichtmikroskop</td><td>Preiswert, live beobachten</td><td>Aufl√∂sung begrenzt (~200 nm)</td></tr>
          <tr><td>REM</td><td>Hohe Aufl√∂sung/Oberfl√§chen</td><td>Nur Vakuum/keine lebenden Proben</td></tr>
          <tr><td>TEM</td><td>Ultrahochaufl√∂sung (innere Strukturen)</td><td>Aufwendige Pr√§paration, 2D-Schnitte</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Save/Load -->
    <section class="card">
      <h2>Fortschritt sichern</h2>
      <div class="toolbar">
        <button id="saveAll" class="btn-secondary">Alles speichern</button>
        <button id="loadAll" class="btn-secondary">Laden</button>
      </div>
    </section>
  </div>
</main>

<script>
/* ============================================================
   MODE TOGGLE
   ============================================================ */
const theoryBtn = document.getElementById('theoryModeBtn');
const practiceBtn = document.getElementById('practiceModeBtn');

theoryBtn.addEventListener('click', () => {
  document.body.className = 'theory-mode';
  theoryBtn.classList.add('active');
  practiceBtn.classList.remove('active');
});

practiceBtn.addEventListener('click', () => {
  document.body.className = 'practice-mode';
  practiceBtn.classList.add('active');
  theoryBtn.classList.remove('active');
});

/* ============================================================
   DATA
   ============================================================ */
const LABELS = ["Okular","Objektiv","Objekttisch","Kreuztisch","Grobtrieb","Feintrieb","Revolver","Fu√ü","Tubus","Stativ","Lampe/Spiegel"];
const DEFAULT_HOTSPOTS = [
  {"name": "Okular", "x": 69.44, "y": 4.55},
  {"name": "Objektiv", "x": 39.34, "y": 39.24},
  {"name": "Objekttisch", "x": 45.22, "y": 58.16},
  {"name": "Kreuztisch", "x": 44.54, "y": 54.02},
  {"name": "Grobtrieb", "x": 71.45, "y": 53.35},
  {"name": "Feintrieb", "x": 69.61, "y": 53.35},
  {"name": "Revolver", "x": 36.51, "y": 35.94},
  {"name": "Fu√ü", "x": 29.26, "y": 65.01},
  {"name": "Tubus", "x": 57.88, "y": 19.87},
  {"name": "Stativ", "x": 63.00, "y": 27.12},
  {"name": "Lampe/Spiegel", "x": 28.27, "y": 70.90}
];

function loadHotspotsFromStorage(){
  try{ const raw=localStorage.getItem('mikro_hotspots'); if(raw) return JSON.parse(raw);}catch(e){}
  return DEFAULT_HOTSPOTS;
}

/* =================== SCORE =================== */
let score=0; const scoreEl=document.getElementById('score');
function addScore(n){ score=Math.max(0,score+n); scoreEl.textContent=score; }

/* =================== AUFGABE 1 (mit Lehrermodus) =================== */
(function(){
  const container = document.getElementById('microscope');
  const labelList = document.getElementById('labelList');
  const msg = document.getElementById('a1msg');
  const teacherBar = document.getElementById('teacherBar');
  const teacherMsg = document.getElementById('teacherMsg');
  const toggleTeacher = document.getElementById('toggleTeacher');
  let teacherMode = false;

  let config = loadHotspotsFromStorage();
  let activeLabel = null;         // Sch√ºler
  let teacherActiveLabel = null;  // Lehrer
  const solved = new Set();

  // Chips erzeugen
  LABELS.forEach(name=>{
    const b=document.createElement('button');
    b.className='label-chip';
    b.textContent=name;
    b.dataset.for=name;
    b.addEventListener('click',()=>{
      if(b.dataset.state==='placed') return;
      document.querySelectorAll('.label-chip').forEach(x=>{ if(x.dataset.state!=='placed') x.dataset.state='idle'; });
      b.dataset.state='active'; activeLabel=b;
    });
    labelList.appendChild(b);
  });

  function renderAll(){
    container.querySelectorAll('.hotspot').forEach(h=>h.remove());
    config.forEach(h=>{
      const el=document.createElement('button');
      el.className='hotspot';
      el.style.left=h.x+'%'; el.style.top=h.y+'%';
      el.dataset.name=h.name;
      el.title=h.name;
      el.addEventListener('click',()=>tryPlace(el));
      container.appendChild(el);
      enableDrag(el,h);
    });
    teacherMsg.textContent = teacherMode ? 'Lehrermodus aktiv' : 'Lehrermodus aus.';
  }

  function getPos(e,ref){
    const r = ref.getBoundingClientRect();
    const x = ((e.clientX - r.left)/r.width)*100;
    const y = ((e.clientY - r.top)/r.height)*100;
    return {x:Math.max(0,Math.min(100,x)), y:Math.max(0,Math.min(100,y))};
  }

  function enableDrag(el, model){
    let dragging=false, offX=0, offY=0;
    const start=(cx,cy)=>{ dragging=true; const r=container.getBoundingClientRect(); offX=((cx-r.left)/r.width)*100 - model.x; offY=((cy-r.top)/r.height)*100 - model.y; document.body.style.userSelect='none'; };
    const move=(cx,cy)=>{ if(!dragging) return; const r=container.getBoundingClientRect(); model.x=Math.max(0,Math.min(100,((cx-r.left)/r.width)*100 - offX)); model.y=Math.max(0,Math.min(100,((cy-r.top)/r.height)*100 - offY)); el.style.left=model.x+'%'; el.style.top=model.y+'%'; };
    const end=()=>{ if(dragging){ dragging=false; document.body.style.userSelect=''; teacherMsg.textContent=`${model.name} ‚Üí ${model.x.toFixed(1)}%, ${model.y.toFixed(1)}%`; } };
    el.addEventListener('mousedown', e=>{ if(!teacherMode) return; e.preventDefault(); start(e.clientX,e.clientY); });
    window.addEventListener('mousemove', e=>move(e.clientX,e.clientY));
    window.addEventListener('mouseup', end);
    el.addEventListener('touchstart', e=>{ if(!teacherMode) return; const t=e.touches[0]; start(t.clientX,t.clientY); }, {passive:true});
    window.addEventListener('touchmove', e=>{ const t=e.touches?.[0]; if(t) move(t.clientX,t.clientY); }, {passive:true});
    window.addEventListener('touchend', end);
  }

  function placeLabel(h, name){
    const tag=document.createElement('div'); tag.className='target-name'; tag.textContent=name; tag.setAttribute('aria-hidden','true'); h.appendChild(tag);
  }
  function tryPlace(h){
    if(!activeLabel){ msg.textContent='W√§hle erst eine Beschriftung aus.'; return; }
    const expect=h.dataset.name, want=activeLabel.dataset.for;
    if(expect===want){
      if(!solved.has(want)){
        h.classList.add('correct'); placeLabel(h,want); solved.add(want);
        activeLabel.dataset.state='placed'; activeLabel=null; addScore(1);
        msg.innerHTML = `<span class="ok">Richtig!</span> ${want} platziert.`;
      }
    }else{
      msg.innerHTML = `<span class="warn">Nicht korrekt.</span> Versuche es erneut.`;
      addScore(-1);
    }
  }

  toggleTeacher.addEventListener('click',()=>{
    teacherMode=!teacherMode;
    teacherBar.setAttribute('aria-hidden', !teacherMode);
    toggleTeacher.setAttribute('aria-pressed', teacherMode);
    teacherMsg.textContent= teacherMode ? 'Lehrermodus aktiv' : 'Lehrermodus aus.';
  });

  document.getElementById('savePos').addEventListener('click', ()=>{
    localStorage.setItem('mikro_hotspots', JSON.stringify(config));
    teacherMsg.textContent='Gespeichert.';
  });
  document.getElementById('loadPos').addEventListener('click', ()=>{
    const raw=localStorage.getItem('mikro_hotspots');
    if(raw){ config=JSON.parse(raw); renderAll(); teacherMsg.textContent='Geladen.'; }
    else teacherMsg.textContent='Keine gespeicherten Positionen.';
  });
  document.getElementById('resetAll').addEventListener('click', ()=>{
    if(confirm('Alle Hotspots auf Standard zur√ºcksetzen?')){
      config=JSON.parse(JSON.stringify(DEFAULT_HOTSPOTS));
      renderAll(); teacherMsg.textContent='Zur√ºckgesetzt.';
    }
  });

  document.getElementById('checkA1').addEventListener('click', ()=>{
    const rest = LABELS.length - solved.size;
    msg.innerHTML = rest===0 ? '<strong class="ok">Alles korrekt platziert.</strong>' : `Noch <b>${rest}</b> offen.`;
  });
  function resetStudentView(){
    solved.clear(); activeLabel=null; msg.textContent='Zur√ºckgesetzt.';
    document.querySelectorAll('.label-chip').forEach(c=>c.dataset.state='idle');
    container.querySelectorAll('.hotspot').forEach(h=>{h.classList.remove('correct'); h.querySelector('.target-name')?.remove();});
  }
  document.getElementById('resetA1').addEventListener('click', resetStudentView);

  // initial render
  renderAll();
  if(localStorage.getItem('mikro_hotspots')){
    const note=document.createElement('div'); note.className='sm-note'; note.textContent='Hinweis: Eigene Hotspots aus dem Speicher geladen.'; document.getElementById('a1').appendChild(note);
  }
})();

/* =================== Aufgabe 2 (Tip & Tap Zuordnung) =================== */
(function(){
  const functionChips = document.querySelectorAll('.function-chip');
  const partBoxes = document.querySelectorAll('.part-box');
  const msg=document.getElementById('a2msg');

  let activeFunction=null;
  const mapOK={
    okular:'blick',
    objektiv:'vergroessert',
    tisch:'traegt',
    grob:'fokussiert-grob',
    fein:'fokussiert-fein',
    lampe:'beleuchtet'
  };

  functionChips.forEach(ch=>{
    ch.addEventListener('click',()=>{
      functionChips.forEach(x=>x.dataset.state='idle');
      ch.dataset.state='active'; activeFunction=ch.dataset.function;
    });
  });

  partBoxes.forEach(box=>{
    box.addEventListener('click',()=>{
      if(!activeFunction){ msg.textContent='W√§hle zuerst eine Funktion aus.'; return; }
      const part=box.dataset.part;
      const ok=mapOK[part]===activeFunction;
      if(ok){
        box.classList.add('correct');
        const el=box.querySelector('.part-function');
        el.textContent=chLabel(activeFunction);
        el.classList.add('filled');
        activeFunction=null;
        functionChips.forEach(x=>x.dataset.state='idle');
        addScore(1);
        msg.innerHTML='<span class="ok">Richtig zugeordnet.</span>';
      }else{
        msg.innerHTML='<span class="warn">Nicht korrekt. Versuche es erneut.</span>';
        addScore(-1);
      }
    });
  });

  function chLabel(id){
    switch(id){
      case 'vergroessert': return 'Bild vergr√∂√üern';
      case 'fokussiert-grob': return 'Fokussieren (grobe Ann√§herung)';
      case 'fokussiert-fein': return 'Feine Scharfstellung';
      case 'traegt': return 'Pr√§parat tragen';
      case 'beleuchtet': return 'Beleuchten';
      case 'blick': return 'Beobachtung';
      default: return id;
    }
  }

  document.getElementById('checkA2').addEventListener('click', ()=>{
    const done=[...partBoxes].every(b=>b.classList.contains('correct'));
    msg.innerHTML = done? '<strong class="ok">Alles korrekt.</strong>' : '<span class="warn">Noch nicht alles korrekt.</span>';
    if(done) addScore(3);
  });
  document.getElementById('resetA2').addEventListener('click', ()=>{
    partBoxes.forEach(b=>{ b.classList.remove('correct'); const el=b.querySelector('.part-function'); el.textContent=''; el.classList.remove('filled');});
    functionChips.forEach(x=>x.dataset.state='idle');
    msg.textContent='Zur√ºckgesetzt.';
  });
})();

/* =================== Aufgabe 3 =================== */
(function(){
  const list=document.getElementById('steps'), msg=document.getElementById('a3msg');
  const orderOK=['licht','objekttrager','kleinste','grob','fein','wechsel'];
  function move(li,dir){
    if(dir==='up'&&li.previousElementSibling){ list.insertBefore(li,li.previousElementSibling);}
    else if(dir==='down'&&li.nextElementSibling){ list.insertBefore(li.nextElementSibling,li);}
  }
  list.querySelectorAll('.step').forEach(li=>{
    li.querySelector('.up').addEventListener('click',()=>move(li,'up'));
    li.querySelector('.down').addEventListener('click',()=>move(li,'down'));
  });
  document.getElementById('checkA3').addEventListener('click', ()=>{
    const now=[...list.children].map(li=>li.dataset.id);
    const ok=now.every((id,i)=>id===orderOK[i]);
    if(ok){ msg.innerHTML='<strong class="ok">Perfekt ‚Äî richtige Reihenfolge!</strong>'; addScore(3); }
    else { let hint=0; for(let i=0;i<now.length;i++){ if(now[i]===orderOK[i]) hint++; }
      msg.innerHTML=`<span class="warn">Noch nicht korrekt.</span> ${hint}/6 korrekt.`; addScore(-1); }
  });
})();

/* =================== Aufgabe 4 =================== */
(function(){
  const msg=document.getElementById('a4msg');
  document.getElementById('checkA4').addEventListener('click', ()=>{
    const boxes=[...document.querySelectorAll('input[type="checkbox"][data-ok]')];
    let ok=0; boxes.forEach(b=>{ const should=b.dataset.ok==='true'; if(b.checked===should) ok++; });
    if(ok===boxes.length){ msg.innerHTML='<strong class="ok">Alles richtig!</strong>'; addScore(3); }
    else { msg.innerHTML=`<span class="warn">Teilweise korrekt:</span> ${ok}/${boxes.length}.`; addScore(-1); }
  });
})();

/* =================== Aufgabe 5 ‚Äì Fokus-Spiel =================== */
(function(){
  const canvas = document.getElementById('lab');
  const ctx = canvas.getContext('2d');

  const hudObj = document.getElementById('hud-obj');
  const hudG = document.getElementById('hud-g');
  const hudF = document.getElementById('hud-f');
  const hudL = document.getElementById('hud-l');
  const grobAngle = document.getElementById('grobAngle');
  const feinAngle = document.getElementById('feinAngle');

  // Fallback-Controls (hidden, aber f√ºr Save/Load weiter genutzt)
  const grobSlider = document.getElementById('grob');
  const feinSlider = document.getElementById('fein');
  const totalMagEl = document.getElementById('total-mag');
  const objectiveButtons = document.querySelectorAll('#objective-selector button');

  // Lade das Pr√§parat-Bild
  const img = new Image();
  let loaded = false;
  let useFallback = false;

  // Zustand
  const okularVergroesserung = 10;
  window.a5_state = {
    aktuellesObjektiv: 4,  // 4, 10, 40
    grob: 0,               // 0..100
    fein: 50,              // 0..100 (Mitte = 50)
    licht: 1.0             // 0.7 .. 1.3
  };

  // Fallback-Funktion f√ºr fehlendes Bild
  function drawFallbackImage(){
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);
    
    // Fokus-Simulation
    const gesamtFokus = calculateFocus();
    const zielEbene = 0.55;
    const abstand = Math.abs(gesamtFokus - zielEbene);
    const blur = Math.min(20, abstand * (100 + window.a5_state.aktuellesObjektiv * 10));
    
    ctx.save();
    
    // Zoom mit Objektiv
    const zoomFaktor = window.a5_state.aktuellesObjektiv / 4;
    ctx.translate(w/2, h/2);
    ctx.scale(zoomFaktor, zoomFaktor);
    ctx.translate(-w/2, -h/2);

    // Helligkeit / Kontrast
    const brightness = window.a5_state.licht;
    const contrast = 1.0;
    ctx.filter = `blur(${blur}px) brightness(${brightness}) contrast(${contrast})`;
    
    // Hintergrund
    ctx.fillStyle = '#111827';
    ctx.fillRect(0,0,w,h);

    // Zelle zeichnen (vereinfachte Demo)
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)/3.5;
    ctx.fillStyle = '#0ea5e9';
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, Math.PI*2);
    ctx.fill();

    // Strukturen
    for(let i=0;i<10;i++){
      const ang = (i/10)*Math.PI*2;
      const x = cx + Math.cos(ang) * r*0.7;
      const y = cy + Math.sin(ang) * r*0.7;
      ctx.fillStyle = '#22c55e';
      ctx.beginPath();
      ctx.arc(x, y, r/10, 0, Math.PI*2);
      ctx.fill();

      // Zellkern
      ctx.fillStyle = '#7c3aed';
      ctx.beginPath();
      ctx.arc(x, y, r/3, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = '#e8d4f0';
    }
    
    ctx.restore();
    ctx.filter = "none";
    
    // Info-Text nur bei starker Unsch√§rfe
    if(blur > 10){
      ctx.fillStyle = 'rgba(96,165,250,0.5)';
      ctx.font = '12px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('Fokussiere mit Grob- und Feintrieb', w/2, h-10);
    }
  }

  // Bild laden
  img.src = "Zelle.png";
  
  img.onload = ()=>{ 
    loaded = true;
    useFallback = false;
    console.log("Zelle.png erfolgreich geladen");
    resize(); 
    draw(); 
  };
  img.onerror = ()=>{ 
    loaded = false; 
    useFallback = true;
    console.warn("Zelle.png konnte nicht geladen werden, nutze Fallback-Grafik");
    resize(); 
    draw(); 
  };

  function resize(){
    const box = document.querySelector('.focus-canvas');
    const s = box.getBoundingClientRect();
    // devicePixelRatio f√ºr scharfe Darstellung (iPad Retina)
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    canvas.width = Math.floor(s.width * dpr);
    canvas.height = Math.floor(s.height * dpr);
    canvas.style.width = s.width + 'px';
    canvas.style.height = s.height + 'px';
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
    draw();
  }
  window.addEventListener('resize', resize);

  function calculateFocus(){
    // Basis-Fokus aus Grob (0..100) und Fein (0..100, zentriert bei 50)
    const grob = window.a5_state.grob / 100;     // 0..1
    const fein = (window.a5_state.fein - 50) / 100; // -0.5..+0.5
    // Objektiv beeinflusst die ‚ÄûSch√§rfentiefe‚Äú
    const faktor = (window.a5_state.aktuellesObjektiv / 40) * 0.2 + 0.9;
    let f = grob + fein * faktor;
    return Math.max(0, Math.min(1, f));
  }

  function draw(){
    if(useFallback){
      drawFallbackImage();
      return;
    }
    
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    // Fokus -> Blur
    const gesamtFokus = calculateFocus();
    const zielEbene = 0.55;
    const abstand = Math.abs(gesamtFokus - zielEbene);
    const blur = Math.min(20, abstand * (100 + window.a5_state.aktuellesObjektiv * 10));

    // Zoom mit Objektiv
    ctx.save();
    const zoomFaktor = window.a5_state.aktuellesObjektiv / 4;
    ctx.translate(w/2, h/2);
    ctx.scale(zoomFaktor, zoomFaktor);
    ctx.translate(-w/2, -h/2);

    // Helligkeit / Kontrast
    const brightness = window.a5_state.licht;
    const contrast = 1.0;
    ctx.filter = `blur(${blur}px) brightness(${brightness}) contrast(${contrast})`;

    // Bild zeichnen
    ctx.drawImage(img, 0, 0, w, h);
    ctx.restore();
    ctx.filter = "none";
  }

  // ---------- Interaktives Bild-Overlay ----------
  const overlay = document.querySelector('.microscope-game .game-overlay');
  let drag = null; // {type:'grob'|'fein', cx, cy}

  function toLocalXY(evt){
    const svg = overlay;
    const rect = svg.getBoundingClientRect();
    const x = (evt.touches ? evt.touches[0].clientX : evt.clientX) - rect.left;
    const y = (evt.touches ? evt.touches[0].clientY : evt.clientY) - rect.top;
    // In viewBox-Koordinaten (0..1000, 0..1500) umrechnen
    const vx = x * (svg.viewBox.baseVal.width / rect.width);
    const vy = y * (svg.viewBox.baseVal.height / rect.height);
    return {x:vx, y:vy};
  }

  function angleToPercent(angleDeg){
    // -150¬∞ .. +150¬∞ -> 0..100%
    const clamped = Math.max(-150, Math.min(150, angleDeg));
    return Math.round(((clamped + 150) / 300) * 100);
  }

  function updateHUD(){
    hudObj.textContent = `${window.a5_state.aktuellesObjektiv}√ó (${window.a5_state.aktuellesObjektiv*okularVergroesserung}√ó)`;
    hudG.textContent = `${window.a5_state.grob}%`;
    hudF.textContent = `${window.a5_state.fein}%`;
    hudL.textContent = `${Math.round(window.a5_state.licht*100)}%`;
    if(totalMagEl) totalMagEl.textContent = `${window.a5_state.aktuellesObjektiv*okularVergroesserung}x`;
  }

  function setGrobFromAngle(cx, cy, px, py){
    const angle = Math.atan2(py - cy, px - cx) * 180/Math.PI;
    const val = angleToPercent(angle);
    window.a5_state.grob = val;
    if(grobSlider) grobSlider.value = val;
    grobAngle.style.transform = `translate(-50%,-50%) rotate(${(val/100)*300-150}deg)`;
    updateHUD(); draw();
  }

  function setFeinFromAngle(cx, cy, px, py){
    const angle = Math.atan2(py - cy, px - cx) * 180/Math.PI;
    const val = angleToPercent(angle);
    window.a5_state.fein = val;
    if(feinSlider) feinSlider.value = val;
    feinAngle.style.transform = `translate(-50%,-50%) rotate(${(val/100)*300-150}deg)`;
    updateHUD(); draw();
  }

  overlay.addEventListener('pointerdown', (e)=>{
    const target = e.target.closest('.hit');
    if(!target) return;
    const type = target.dataset.control;

    if(type === 'revolver'){
      // Objektiv umschalten
      const seq = [4,10,40];
      const idx = seq.indexOf(window.a5_state.aktuellesObjektiv);
      window.a5_state.aktuellesObjektiv = seq[(idx+1)%seq.length];
      // Buttons (Fallback) syncen
      objectiveButtons.forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.mag,10)===window.a5_state.aktuellesObjektiv));
      updateHUD(); draw();
      return;
    }
    if(type === 'lampe'){
      // Lichtstufe toggeln 70% -> 100% -> 130%
      const steps = [0.7,1.0,1.3];
      const i = steps.indexOf(window.a5_state.licht);
      window.a5_state.licht = steps[(i+1)%steps.length];
      updateHUD(); draw();
      return;
    }

    // Drag f√ºr Grob/Fein starten
    const bbox = target.getBBox();
    drag = {type, cx:bbox.x + bbox.width/2, cy:bbox.y + bbox.height/2};
    const p = toLocalXY(e);
    if(type==='grob') setGrobFromAngle(drag.cx, drag.cy, p.x, p.y);
    if(type==='fein') setFeinFromAngle(drag.cx, drag.cy, p.x, p.y);
    overlay.setPointerCapture(e.pointerId);
  });

  overlay.addEventListener('pointermove', (e)=>{
    if(!drag) return;
    const p = toLocalXY(e);
    if(drag.type==='grob') setGrobFromAngle(drag.cx, drag.cy, p.x, p.y);
    if(drag.type==='fein') setFeinFromAngle(drag.cx, drag.cy, p.x, p.y);
  });

  overlay.addEventListener('pointerup', ()=>{ drag=null; });
  overlay.addEventListener('pointercancel', ()=>{ drag=null; });

  // Fallback-Events (Tastatur/Screenreader) ‚Äî nur registrieren, wenn vorhanden
  if(grobSlider) grobSlider.addEventListener('input', ()=>{
    if (window.a5_state.aktuellesObjektiv >= 40) alert("VORSICHT! Grobtrieb bei starker Vergr√∂√üerung nicht verwenden!");
    window.a5_state.grob = +grobSlider.value;
    updateHUD(); draw();
  });
  if(feinSlider) feinSlider.addEventListener('input', ()=>{
    window.a5_state.fein = +feinSlider.value;
    updateHUD(); draw();
  });
  objectiveButtons.forEach(button => {
    button.addEventListener('click', () => {
      objectiveButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      window.a5_state.aktuellesObjektiv = parseInt(button.dataset.mag, 10);
      updateHUD(); draw();
    });
  });

  document.getElementById('checkA5').addEventListener('click', ()=>{
    const gesamtFokus = calculateFocus();
    const zielEbene = 0.55;
    const abstand = Math.abs(gesamtFokus - zielEbene);
    const blur = Math.min(20, abstand * (100 + window.a5_state.aktuellesObjektiv * 10));
    const msg=document.getElementById('a5msg');

    if(blur < 2){
      msg.innerHTML = '<strong class="ok">Sehr gut! Bild ist scharf.</strong>';
      addScore(3);
    } else {
      let hint = gesamtFokus < zielEbene 
        ? 'Du musst noch etwas h√∂her fokussieren (Grob/Fein nach rechts).' 
        : 'Du bist zu hoch (Grob/Fein nach links).';
      msg.innerHTML = `<span class="warn">Noch unscharf. ${hint}</span>`;
      addScore(-1);
    }
  });

  // API f√ºr Save/Load
  window.a5_applyLoadedState = function(s){
    if(!s) return;
    if(typeof s.objektiv==='number') window.a5_state.aktuellesObjektiv = s.objektiv;
    if(typeof s.grob==='number') window.a5_state.grob = s.grob;
    if(typeof s.fein==='number') window.a5_state.fein = s.fein;
    if(typeof s.licht==='number') window.a5_state.licht = s.licht;

    // Fallback-UI syncen
    if(grobSlider) grobSlider.value = window.a5_state.grob;
    if(feinSlider) feinSlider.value = window.a5_state.fein;
    const btn = document.querySelector(`#objective-selector button[data-mag="${window.a5_state.aktuellesObjektiv}"]`);
    if(btn){
      document.querySelectorAll('#objective-selector button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }
    updateHUD(); draw();
  };

  document.getElementById('resetA5').addEventListener('click', ()=>{
    window.a5_state = {aktuellesObjektiv:4, grob:0, fein:50, licht:1.0};
    if(grobSlider) grobSlider.value = 0;
    if(feinSlider) feinSlider.value = 50;
    document.querySelectorAll('#objective-selector button').forEach(b=>b.classList.remove('active'));
    const first = document.querySelector('#objective-selector button[data-mag="4"]'); if(first) first.classList.add('active');
    grobAngle.style.transform = `translate(-50%,-50%) rotate(-150deg)`;
    feinAngle.style.transform = `translate(-50%,-50%) rotate(0deg)`;
    updateHUD(); draw();
    document.getElementById('a5msg').textContent='Zur√ºckgesetzt.';
  });

  function initUI(){
    // Default 4x aktiv
    const first = document.querySelector('#objective-selector button[data-mag="4"]');
    if(first) first.classList.add('active');
    updateHUD();
    // Indikator-Position
    grobAngle.style.transform = `translate(-50%,-50%) rotate(-150deg)`;
    feinAngle.style.transform = `translate(-50%,-50%) rotate(0deg)`;
    // Canvas
    resize();
    // Fallback falls Bild fehlt
    setTimeout(() => {
      if(!loaded){
        console.warn("Bild konnte nicht geladen werden, verwende Fallback");
        drawFallbackImage();
      }
    }, 1000);
  }
  initUI();
})();

/* =================== SAVE/LOAD Fortschritt =================== */
(function(){
  document.getElementById('saveAll').addEventListener('click', ()=>{
    const data = {
      score,
      hotspots: (()=>{
        try{ return JSON.parse(localStorage.getItem('mikro_hotspots')||'null'); }catch(e){ return null; }
      })(),
      a5: window.a5_state
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='mikro-fortschritt.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  document.getElementById('loadAll').addEventListener('click', ()=>{
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=async()=>{
      try{
        const file = inp.files?.[0]; if(!file) return;
        const txt = await file.text();
        const d = JSON.parse(txt);
        if(d.hotspots){ localStorage.setItem('mikro_hotspots', JSON.stringify(d.hotspots)); }
        if(d.a5){ window.a5_applyLoadedState(d.a5); }
        if(typeof d.score==='number'){ 
          score=d.score; 
          document.getElementById('score').textContent=score; 
        }
        alert('Fortschritt geladen.');
      }catch(e){ 
        alert('Konnte Datei nicht laden: '+e.message); 
      }
    };
    inp.click();
  });
})();
</script>
</body>
</html>
